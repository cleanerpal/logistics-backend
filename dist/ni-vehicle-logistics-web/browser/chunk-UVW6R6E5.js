import{a as be,d as Se,f as Pe,g as Ie}from"./chunk-IWKF2V5Q.js";import{a as Ce,b as Me,c as Ee,d as Fe,i as ye}from"./chunk-PQIIHW7R.js";import"./chunk-GW6WOXIL.js";import"./chunk-MS4AQ6UA.js";import{b as me,c as le}from"./chunk-LDLE5TDT.js";import{a as ve,b as he}from"./chunk-DJMXPRNS.js";import{d as xe}from"./chunk-U5UIMM6O.js";import"./chunk-PP7BOOB7.js";import{a as ae}from"./chunk-FL7UC7QU.js";import"./chunk-DQFV6XNM.js";import{a as Q,b as X,c as Y,f as Z,h as ee}from"./chunk-OFY7VGJP.js";import{b as te,c as ne,e as re,f as ie,i as oe}from"./chunk-P7ITNQJW.js";import{a as fe,b as ge}from"./chunk-HDC6EVXZ.js";import{b as _e}from"./chunk-Q2NIOR5G.js";import{C as pe,E as se,H as ce,I as de,J as ue,b as R,d as x,g as j,h as G,l as z,m as $,o as L,q as H,r as J,u as W,w as K}from"./chunk-E6Y7ME2X.js";import"./chunk-ZO4V6NUC.js";import{a as D,c as T}from"./chunk-4PPYA6ZN.js";import{ea as F,ga as N,i as O,j as w,ja as B,ka as b,o as k,pa as U,ta as A,ua as V,xa as q}from"./chunk-3O2P3FIP.js";import{Cb as m,Lb as r,Mb as e,Nb as f,Rb as I,Vb as M,Wb as _,db as a,ec as y,fc as o,hc as E,ib as g,pa as h,pb as P,qa as C,vb as d}from"./chunk-NXWLSP6D.js";import{g as v}from"./chunk-RA2WU32H.js";function we(i,n){i&1&&(r(0,"div",7),f(1,"mat-spinner",8),e())}function ke(i,n){if(i&1&&(r(0,"mat-option",32),o(1),e()),i&2){let t=n.$implicit;m("value",t.id),a(),E(" ",t.name," ")}}function De(i,n){i&1&&(r(0,"mat-error"),o(1," Driver is required "),e())}function Te(i,n){if(i&1&&(r(0,"mat-option",32),o(1),e()),i&2){let t=n.$implicit;m("value",t),a(),E(" ",t," ")}}function Ne(i,n){i&1&&(r(0,"mat-error"),o(1," Expense type is required "),e())}function Be(i,n){i&1&&(r(0,"mat-error"),o(1," Amount is required "),e())}function Ue(i,n){i&1&&(r(0,"mat-error"),o(1," Amount must be greater than 0 "),e())}function Ae(i,n){i&1&&(r(0,"mat-error"),o(1," Date is required "),e())}function Ve(i,n){if(i&1&&(r(0,"div",33),f(1,"mat-progress-spinner",34),r(2,"span"),o(3),e()()),i&2){let t=_(2);a(),m("value",t.uploadProgress),a(2),E("Uploading: ",t.uploadProgress,"%")}}function qe(i,n){i&1&&f(0,"mat-spinner",35)}function Re(i,n){i&1&&(r(0,"span")(1,"mat-icon"),o(2,"save"),e(),o(3," Save Expense "),e())}function je(i,n){if(i&1){let t=I();r(0,"form",9),M("ngSubmit",function(){h(t);let l=_();return C(l.onSubmit())}),r(1,"mat-card",10)(2,"mat-card-header")(3,"mat-card-title"),o(4,"Expense Details"),e()(),r(5,"mat-card-content")(6,"div",11)(7,"mat-form-field",12)(8,"mat-label"),o(9,"Driver"),e(),r(10,"mat-select",13),d(11,ke,2,2,"mat-option",14),e(),d(12,De,2,0,"mat-error",15),e()(),r(13,"div",11)(14,"mat-form-field",12)(15,"mat-label"),o(16,"Expense Type"),e(),r(17,"mat-select",16),d(18,Te,2,2,"mat-option",14),e(),d(19,Ne,2,0,"mat-error",15),e()(),r(20,"div",11)(21,"mat-form-field",12)(22,"mat-label"),o(23,"Amount (\xA3)"),e(),f(24,"input",17),r(25,"span",18),o(26,"\xA3\xA0"),e(),d(27,Be,2,0,"mat-error",15)(28,Ue,2,0,"mat-error",15),e()(),r(29,"div",11)(30,"mat-form-field",12)(31,"mat-label"),o(32,"Date"),e(),f(33,"input",19)(34,"mat-datepicker-toggle",20)(35,"mat-datepicker",null,0),d(37,Ae,2,0,"mat-error",15),e()(),r(38,"div",11)(39,"mat-form-field",12)(40,"mat-label"),o(41,"Notes"),e(),f(42,"textarea",21),e()(),r(43,"div",11)(44,"div",22)(45,"input",23,1),M("change",function(l){h(t);let u=_();return C(u.onFileSelected(l))}),e(),r(47,"mat-form-field",12)(48,"mat-label"),o(49,"Receipt"),e(),f(50,"input",24),r(51,"button",25),M("click",function(){h(t);let l=y(46);return C(l.click())}),r(52,"mat-icon"),o(53,"attach_file"),e()()(),r(54,"div",26),o(55," Upload a photo of your receipt (optional). Accepted formats: JPEG, PNG, PDF "),e(),d(56,Ve,4,2,"div",27),e()()()(),r(57,"div",28)(58,"button",29),M("click",function(){h(t);let l=_();return C(l.onCancel())}),r(59,"mat-icon"),o(60,"cancel"),e(),o(61," Cancel "),e(),r(62,"button",30),d(63,qe,1,0,"mat-spinner",31)(64,Re,4,0,"span",15),e()()()}if(i&2){let t,p,l,u,c,S=y(36),s=_();m("formGroup",s.expenseForm),a(11),m("ngForOf",s.drivers),a(),m("ngIf",(t=s.expenseForm.get("driverId"))==null?null:t.hasError("required")),a(6),m("ngForOf",s.expenseTypes),a(),m("ngIf",(p=s.expenseForm.get("type"))==null?null:p.hasError("required")),a(8),m("ngIf",(l=s.expenseForm.get("amount"))==null?null:l.hasError("required")),a(),m("ngIf",(u=s.expenseForm.get("amount"))==null?null:u.hasError("min")),a(5),m("matDatepicker",S),a(),m("for",S),a(3),m("ngIf",(c=s.expenseForm.get("date"))==null?null:c.hasError("required")),a(19),m("ngIf",s.isUploading),a(6),m("disabled",s.submitting||s.isUploading),a(),m("ngIf",s.submitting),a(),m("ngIf",!s.submitting)}}var Oe=class i{constructor(n,t,p,l,u,c){this.formBuilder=n;this.firestore=t;this.storage=p;this.route=l;this.router=u;this.snackBar=c}expenseForm;loading=!1;submitting=!1;selectedFile=null;uploadProgress=0;isUploading=!1;expenseTypes=["Fuel","Toll","Car Wash","Vacuum","Other"];drivers=[];ngOnInit(){this.initializeForm(),this.loadDrivers()}initializeForm(){this.expenseForm=this.formBuilder.group({driverId:["",x.required],type:["",x.required],amount:["",[x.required,x.min(.01)]],date:[new Date,x.required],notes:[""],receipt:[""]})}loadDrivers(){return v(this,null,function*(){this.loading=!0;try{let n=b(this.firestore,"Users"),t=V(n,q("role","==","Driver"),A("displayName")),p=yield U(t);this.drivers=p.docs.map(l=>({id:l.id,name:l.data().displayName||"Unknown Driver"})),this.loading=!1}catch(n){console.error("Error loading drivers:",n),this.snackBar.open("Error loading drivers. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.loading=!1}})}onFileSelected(n){let t=n.target;t.files&&t.files.length>0&&(this.selectedFile=t.files[0],this.expenseForm.get("receipt")?.setValue(this.selectedFile.name))}uploadReceipt(){return v(this,null,function*(){if(!this.selectedFile)return null;this.isUploading=!0;try{let n=`receipts/${new Date().getTime()}_${this.selectedFile.name}`,t=Pe(this.storage,n),p=Ie(t,this.selectedFile);return new Promise((l,u)=>{p.on("state_changed",c=>{this.uploadProgress=Math.round(c.bytesTransferred/c.totalBytes*100)},c=>{console.error("Upload failed:",c),this.isUploading=!1,u(null)},()=>v(this,null,function*(){let c=yield Se(p.snapshot.ref);this.isUploading=!1,l(c)}))})}catch(n){return console.error("Error during upload:",n),this.isUploading=!1,null}})}onSubmit(){return v(this,null,function*(){if(this.expenseForm.invalid){Object.keys(this.expenseForm.controls).forEach(n=>{this.expenseForm.get(n)?.markAsTouched()});return}this.submitting=!0;try{let n=null;this.selectedFile&&(n=yield this.uploadReceipt());let t=this.expenseForm.get("driverId")?.value,p=this.drivers.find(c=>c.id===t),l={driverId:t,driverName:p?.name||"Unknown Driver",type:this.expenseForm.get("type")?.value,amount:parseFloat(this.expenseForm.get("amount")?.value),date:F.fromDate(this.expenseForm.get("date")?.value),notes:this.expenseForm.get("notes")?.value||"",receiptUrl:n,status:"Pending",chargeable:!1,createdAt:F.now(),updatedAt:F.now()},u=b(this.firestore,"Expenses");yield B(u,l),this.snackBar.open("Expense created successfully","Close",{duration:3e3}),this.router.navigate(["/expenses"])}catch(n){console.error("Error creating expense:",n),this.snackBar.open("Error creating expense. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]})}finally{this.submitting=!1}})}onCancel(){this.router.navigate(["/expenses"])}static \u0275fac=function(t){return new(t||i)(g(W),g(N),g(be),g(D),g(T),g(_e))};static \u0275cmp=P({type:i,selectors:[["app-expense-form"]],decls:6,vars:2,consts:[["picker",""],["fileInput",""],[1,"expense-form-container"],[1,"page-header"],[1,"page-title"],["class","loading-container",4,"ngIf"],[3,"formGroup","ngSubmit",4,"ngIf"],[1,"loading-container"],["diameter","50"],[3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-row"],["appearance","outline"],["formControlName","driverId"],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["formControlName","type"],["matInput","","type","number","step","0.01","min","0.01","formControlName","amount"],["matTextPrefix",""],["matInput","","formControlName","date",3,"matDatepicker"],["matIconSuffix","",3,"for"],["matInput","","formControlName","notes","rows","3","placeholder","Enter any additional details about this expense"],[1,"receipt-upload"],["type","file","accept","image/jpeg,image/png,application/pdf",2,"display","none",3,"change"],["matInput","","formControlName","receipt","readonly","","placeholder","No file selected"],["type","button","matSuffix","","mat-icon-button","",3,"click"],[1,"upload-note"],["class","upload-progress",4,"ngIf"],[1,"form-actions"],["type","button","mat-stroked-button","",3,"click"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20",4,"ngIf"],[3,"value"],[1,"upload-progress"],["mode","determinate","diameter","30",3,"value"],["diameter","20"]],template:function(t,p){t&1&&(r(0,"div",2)(1,"div",3)(2,"h1",4),o(3,"Add New Expense"),e()(),d(4,we,2,0,"div",5)(5,je,65,14,"form",6),e()),t&2&&(a(4),m("ngIf",p.loading),a(),m("ngIf",!p.loading))},dependencies:[k,O,w,K,z,R,$,j,G,J,L,H,ce,se,pe,ee,Q,Y,Z,X,ye,Me,Ee,Fe,ae,oe,te,ne,re,ie,ue,de,le,me,Ce,ge,fe,he,ve,xe],styles:[".expense-form-container[_ngcontent-%COMP%]{padding:20px;background-color:#f5f5f5;min-height:100%}.page-header[_ngcontent-%COMP%]{margin-bottom:24px}.page-title[_ngcontent-%COMP%]{font-size:24px;font-weight:500;color:#4a3c31;margin:0}.loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:200px}.form-card[_ngcontent-%COMP%]{margin-bottom:24px;border-radius:8px;box-shadow:0 2px 10px #0000001a}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]{padding:16px 16px 0}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]   .mat-mdc-card-title[_ngcontent-%COMP%]{color:#4a3c31;font-size:18px;margin-bottom:8px}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-content[_ngcontent-%COMP%]{padding:16px}.form-row[_ngcontent-%COMP%]{margin-bottom:16px;width:100%}.receipt-upload[_ngcontent-%COMP%]{width:100%}.receipt-upload[_ngcontent-%COMP%]   .upload-note[_ngcontent-%COMP%]{font-size:12px;color:#666;margin-top:4px}.receipt-upload[_ngcontent-%COMP%]   .upload-progress[_ngcontent-%COMP%]{display:flex;align-items:center;margin-top:8px}.receipt-upload[_ngcontent-%COMP%]   .upload-progress[_ngcontent-%COMP%]   mat-progress-spinner[_ngcontent-%COMP%]{margin-right:12px}.receipt-upload[_ngcontent-%COMP%]   .upload-progress[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:14px;color:#4a3c31}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:16px;margin-top:24px;margin-bottom:40px}.form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:120px}@media (max-width: 576px){.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}button[color=primary][_ngcontent-%COMP%]{background-color:#c19a6b}button[color=primary][_ngcontent-%COMP%]:disabled{background-color:#0000001f}"]})};export{Oe as ExpenseFormComponent};
