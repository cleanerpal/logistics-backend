import{a as Vt,b as Gt,c as Lt,d as Qt,e as Zt,f as Yt,g as zt,h as Xt,i as Se}from"./chunk-ZJA6YHPC.js";import{a as Wt,b as er,c as tr}from"./chunk-MTSSNG6B.js";import{a as $t,b as Ut}from"./chunk-IDK22FN7.js";import{a as Jt,b as Rt,c as At,e as Bt,f as Ht,h as Ee}from"./chunk-RDAIYJSK.js";import{b as rr,c as ir,d as nr}from"./chunk-DWEM3L4R.js";import{b as Kt}from"./chunk-ESJIWLK4.js";import"./chunk-F5X5MWHG.js";import{b as _t}from"./chunk-6ZM5HFJH.js";import{a as Ft,b as wt,c as Tt,d as It,i as Pt}from"./chunk-PQIIHW7R.js";import"./chunk-GW6WOXIL.js";import"./chunk-MS4AQ6UA.js";import{b as se,c as pe}from"./chunk-LDLE5TDT.js";import{a as xe,b as ye}from"./chunk-DJMXPRNS.js";import{d as Ce}from"./chunk-U5UIMM6O.js";import"./chunk-PP7BOOB7.js";import{a as ce}from"./chunk-FL7UC7QU.js";import{a as kt,b as Nt,c as qt,d as Ot}from"./chunk-RN3HN37D.js";import{c as jt}from"./chunk-EM5VPPUM.js";import{a as gt,b as vt,c as ht,d as bt,e as Ct,f as xt,g as yt,h as Et,i as St,j as Dt,l as Mt}from"./chunk-HITQB7VJ.js";import"./chunk-DQFV6XNM.js";import{a as dt,b as ct,c as st,f as pt,h as ae}from"./chunk-OFY7VGJP.js";import{b as le,c as me,f as ut,i as de}from"./chunk-P7ITNQJW.js";import{a as ve,b as he}from"./chunk-HDC6EVXZ.js";import{b as be}from"./chunk-Q2NIOR5G.js";import{C as ft,E as ue,H as fe,I as _e,J as ge,b as z,d as s,g as X,h as W,i as Ne,l as ee,m as te,n as at,o as re,p as lt,q as ie,t as mt,u as ne,w as oe}from"./chunk-E6Y7ME2X.js";import"./chunk-ZO4V6NUC.js";import{a as it,c as nt,g as ot}from"./chunk-4PPYA6ZN.js";import{ea as T,ga as Y,i as K,ia as Pe,j as Q,ja as H,ka as I,ma as j,o as Z,oa as V,pa as B,ta as ke,ua as q,wa as G,xa as O}from"./chunk-3O2P3FIP.js";import{$b as Fe,Cb as l,Eb as J,Lb as i,Mb as e,Nb as p,Ob as F,Pb as w,Rb as P,Vb as D,Wb as b,ac as we,bc as Te,db as a,ec as R,fc as n,ga as y,gc as A,hc as N,ib as tt,ic as rt,jc as Ie,pa as E,pb as U,qa as S,vb as c}from"./chunk-NXWLSP6D.js";import{a as Me,b as et,g as k}from"./chunk-RA2WU32H.js";var br=["currentDriverSignature"],Cr=["newDriverSignature"];function xr(r,t){r&1&&n(0,"Handover Details")}function yr(r,t){r&1&&(i(0,"mat-error"),n(1," Odometer reading is required "),e())}function Er(r,t){r&1&&(i(0,"mat-error"),n(1," Current location is required "),e())}function Sr(r,t){r&1&&(i(0,"mat-error"),n(1," Handover reason is required "),e())}function Dr(r,t){r&1&&(i(0,"mat-error"),n(1,' Notes are required for "Other" reason '),e())}function Mr(r,t){if(r&1&&(F(0),i(1,"mat-form-field",10)(2,"mat-label"),n(3,"Notes"),e(),p(4,"textarea",36),c(5,Dr,2,0,"mat-error",12),e(),w()),r&2){let o,m=b();a(5),l("ngIf",(o=m.handoverDetailsForm.get("notes"))==null?null:o.hasError("required"))}}function Fr(r,t){r&1&&n(0,"Driver Selection")}function wr(r,t){if(r&1&&(i(0,"mat-list-option",40)(1,"div",41)(2,"div",42)(3,"div",43),n(4),e(),i(5,"div",44),n(6),e()(),i(7,"mat-icon",45),n(8,"arrow_forward"),e()()()),r&2){let o=t.$implicit;l("value",o.id),a(4),A(o.name),a(2),A(o.role)}}function Tr(r,t){if(r&1&&(i(0,"div",37)(1,"mat-selection-list",38),c(2,wr,9,3,"mat-list-option",39),e()()),r&2){let o=b();a(),l("multiple",!1),a(),l("ngForOf",o.teamMembers)}}function Ir(r,t){r&1&&(i(0,"div",46)(1,"p"),n(2,"No available drivers found for this team."),e()())}function Pr(r,t){r&1&&n(0,"Confirmation")}function kr(r,t){r&1&&(i(0,"mat-error"),n(1," Notes are required when skipping signatures "),e())}function Nr(r,t){if(r&1&&(i(0,"mat-form-field",47)(1,"mat-label"),n(2,"Signature Skip Reason"),e(),p(3,"textarea",48),c(4,kr,2,0,"mat-error",12),e()),r&2){let o=b();a(3),l("formControl",o.skipNotesControl),a(),l("ngIf",o.skipNotesControl.hasError("required"))}}function qr(r,t){r&1&&p(0,"mat-spinner",49)}function Or(r,t){r&1&&(i(0,"span")(1,"mat-icon"),n(2,"check"),e(),n(3," Complete Handover "),e())}var De=class r{firestore=y(Y);formBuilder=y(ne);dialogRef=y(Jt);snackBar=y(be);data;currentDriverCanvas;newDriverCanvas;handoverDetailsForm;driverSelectionForm;skipSignaturesControl=this.formBuilder.control(!1);skipNotesControl=this.formBuilder.control({value:"",disabled:!0},[s.required]);teamMembers=[];currentDriverCtx=null;newDriverCtx=null;isDrawingCurrent=!1;isDrawingNew=!1;saving=!1;currentDriverId=null;currentDriverName="Unknown";constructor(t){this.data=t,this.handoverDetailsForm=this.formBuilder.group({odometer:["",[s.required]],location:["",[s.required]],reason:["",[s.required]],notes:[""]}),this.driverSelectionForm=this.formBuilder.group({driverId:["",[s.required]]}),this.handoverDetailsForm.get("reason")?.valueChanges.subscribe(o=>{let m=this.handoverDetailsForm.get("notes");o==="Other"?m?.setValidators([s.required]):m?.clearValidators(),m?.updateValueAndValidity()}),this.skipSignaturesControl.valueChanges.subscribe(o=>{o?this.skipNotesControl.enable():this.skipNotesControl.disable()})}ngOnInit(){this.loadTeamMembers(),this.loadCurrentDriver()}ngAfterViewInit(){setTimeout(()=>{this.initializeSignatureCanvases()},500)}loadTeamMembers(){return k(this,null,function*(){try{let t=q(I(this.firestore,"Users"),O("team","==",this.data.team)),o=yield B(t);this.teamMembers=[],o.docs.length>0&&o.docs.forEach(m=>{let d=m.data();this.teamMembers.push(d)})}catch(t){console.error("Error loading team members:",t),this.snackBar.open("Error loading team members. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]})}})}loadCurrentDriver(){return k(this,null,function*(){try{if(!this.data.jobId){console.error("No job ID provided");return}let t=j(this.firestore,"Jobs",this.data.jobId),o=yield V(t);if(o.exists()){let g=o.data();if(g.currentDriverId&&(this.currentDriverId=g.currentDriverId,this.currentDriverId)){let _=j(this.firestore,"Users",this.currentDriverId),v=yield V(_);if(v.exists()){let h=v.data();this.currentDriverName=h.displayName||h.email||"Unknown"}}}let m=I(this.firestore,"Handovers"),d=q(m,O("jobId","==",this.data.jobId)),u=yield B(d)}catch(t){console.error("Error loading current driver:",t)}})}initializeSignatureCanvases(){let t=this.currentDriverCanvas.nativeElement;this.currentDriverCtx=t.getContext("2d"),this.currentDriverCtx&&(this.currentDriverCtx.lineWidth=2,this.currentDriverCtx.lineCap="round",this.currentDriverCtx.strokeStyle="#333333",this.setupSignatureEvents(t,"current"));let o=this.newDriverCanvas.nativeElement;this.newDriverCtx=o.getContext("2d"),this.newDriverCtx&&(this.newDriverCtx.lineWidth=2,this.newDriverCtx.lineCap="round",this.newDriverCtx.strokeStyle="#333333",this.setupSignatureEvents(o,"new"))}setupSignatureEvents(t,o){let m=o==="current"?this.currentDriverCtx:this.newDriverCtx,d=!1,u=0,g=0;t.addEventListener("mousedown",_=>{d=!0;let v=t.getBoundingClientRect();u=_.clientX-v.left,g=_.clientY-v.top}),t.addEventListener("mousemove",_=>{if(!d||!m)return;let v=t.getBoundingClientRect(),h=_.clientX-v.left,C=_.clientY-v.top;m.beginPath(),m.moveTo(u,g),m.lineTo(h,C),m.stroke(),u=h,g=C,o==="current"?this.isDrawingCurrent=!0:this.isDrawingNew=!0}),["mouseup","mouseout"].forEach(_=>{t.addEventListener(_,()=>{d=!1})}),t.addEventListener("touchstart",_=>{_.preventDefault();let v=_.touches[0],h=t.getBoundingClientRect();u=v.clientX-h.left,g=v.clientY-h.top,d=!0}),t.addEventListener("touchmove",_=>{if(_.preventDefault(),!d||!m)return;let v=_.touches[0],h=t.getBoundingClientRect(),C=v.clientX-h.left,M=v.clientY-h.top;m.beginPath(),m.moveTo(u,g),m.lineTo(C,M),m.stroke(),u=C,g=M,o==="current"?this.isDrawingCurrent=!0:this.isDrawingNew=!0}),t.addEventListener("touchend",_=>{_.preventDefault(),d=!1})}clearSignature(t){if(t==="current"&&this.currentDriverCtx){let o=this.currentDriverCanvas.nativeElement;this.currentDriverCtx.clearRect(0,0,o.width,o.height),this.isDrawingCurrent=!1}else if(t==="new"&&this.newDriverCtx){let o=this.newDriverCanvas.nativeElement;this.newDriverCtx.clearRect(0,0,o.width,o.height),this.isDrawingNew=!1}}getSignatureDataUrl(t){let o=t==="current"?this.currentDriverCanvas?.nativeElement:this.newDriverCanvas?.nativeElement;return o?o.toDataURL():null}get submitDisabled(){return this.skipSignaturesControl.value?this.skipNotesControl.invalid:!this.isDrawingCurrent||!this.isDrawingNew}completeHandover(){return k(this,null,function*(){if(this.handoverDetailsForm.invalid||this.driverSelectionForm.invalid){this.snackBar.open("Please complete all required fields.","Close",{duration:3e3});return}if(!this.skipSignaturesControl.value&&(!this.isDrawingCurrent||!this.isDrawingNew)){this.snackBar.open('Both signatures are required or check "Skip signatures".',"Close",{duration:3e3});return}if(this.skipSignaturesControl.value&&this.skipNotesControl.invalid){this.snackBar.open("Notes are required when skipping signatures.","Close",{duration:3e3});return}this.saving=!0;try{let t=this.handoverDetailsForm.value,o=this.driverSelectionForm.get("driverId")?.value,m=I(this.firestore,"Handovers");yield H(m,{jobId:this.data.jobId,previousDriverId:this.currentDriverId,newDriverId:o,odometer:t.odometer,location:t.location,reason:t.reason,notes:t.reason==="Other"?t.notes:"",skipSignatures:this.skipSignaturesControl.value,skipSignaturesNotes:this.skipSignaturesControl.value?this.skipNotesControl.value:"",previousDriverSignature:this.skipSignaturesControl.value?null:this.getSignatureDataUrl("current"),newDriverSignature:this.skipSignaturesControl.value?null:this.getSignatureDataUrl("new"),timestamp:T.now()});let d=j(this.firestore,"Jobs",this.data.jobId);yield G(d,{currentDriverId:o,updatedAt:T.now()});let u=I(this.firestore,"DriverTimeline");if(this.currentDriverId){let v=q(u,O("jobId","==",this.data.jobId),O("driverId","==",this.currentDriverId),O("endTime","==",null)),h=yield B(v);h.docs.length>0&&h.docs.forEach(C=>{let M=C.data();M.notes&&G(C.ref,{endTime:T.now(),notes:`Handover to another driver: ${M.notes}`})})}let g="",_=this.teamMembers.find(v=>v.id===o);_&&(g=_.name),yield H(u,{jobId:this.data.jobId,driverId:o,driverName:g,startTime:T.now(),endTime:null,notes:`Received handover: ${t.reason}`,isCurrent:!0}),this.dialogRef.close({success:!0})}catch(t){console.error("Error completing handover:",t),this.snackBar.open("Error completing handover. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.saving=!1}})}static \u0275fac=function(o){return new(o||r)(tt(Rt))};static \u0275cmp=U({type:r,selectors:[["app-handover-dialog"]],viewQuery:function(o,m){if(o&1&&(Fe(br,5),Fe(Cr,5)),o&2){let d;we(d=Te())&&(m.currentDriverCanvas=d.first),we(d=Te())&&(m.newDriverCanvas=d.first)}},decls:92,vars:18,consts:[["stepper",""],["currentDriverSignature",""],["newDriverSignature",""],["mat-dialog-title",""],[1,"mat-typography"],[3,"linear"],[3,"stepControl"],["matStepLabel",""],[3,"formGroup"],[1,"step-content"],["appearance","outline"],["matInput","","type","number","formControlName","odometer"],[4,"ngIf"],["matInput","","formControlName","location"],["formControlName","reason"],["value","Standard Break"],["value","Emergency"],["value","Planned Rotation"],["value","Other"],[1,"step-actions"],["mat-button","","matStepperNext","",3,"disabled"],["class","driver-list-container",4,"ngIf"],["class","no-drivers",4,"ngIf"],["mat-button","","matStepperPrevious",""],[1,"signatures-container"],[1,"signature-section"],[1,"signature-box"],["width","300","height","150"],[1,"signature-actions"],["mat-stroked-button","","type","button",3,"click"],[1,"skip-signature-section"],[1,"skip-checkbox-container"],["color","warn",3,"formControl"],["appearance","outline","class","skip-notes-field",4,"ngIf"],["mat-raised-button","","color","primary",3,"click","disabled"],["diameter","20",4,"ngIf"],["matInput","","formControlName","notes","rows","3"],[1,"driver-list-container"],["formControlName","driverId",3,"multiple"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"driver-option"],[1,"driver-info"],[1,"driver-name"],[1,"driver-role"],[1,"selection-icon"],[1,"no-drivers"],["appearance","outline",1,"skip-notes-field"],["matInput","","rows","3","placeholder","Explain why signatures are being skipped...",3,"formControl"],["diameter","20"]],template:function(o,m){if(o&1){let d=P();i(0,"h2",3),n(1,"Initiate Handover"),e(),i(2,"mat-dialog-content",4)(3,"mat-vertical-stepper",5,0)(5,"mat-step",6),c(6,xr,1,0,"ng-template",7),i(7,"form",8)(8,"div",9)(9,"mat-form-field",10)(10,"mat-label"),n(11,"Odometer Reading"),e(),p(12,"input",11),c(13,yr,2,0,"mat-error",12),e(),i(14,"mat-form-field",10)(15,"mat-label"),n(16,"Current Location"),e(),p(17,"input",13),c(18,Er,2,0,"mat-error",12),e(),i(19,"mat-form-field",10)(20,"mat-label"),n(21,"Handover Reason"),e(),i(22,"mat-select",14)(23,"mat-option",15),n(24,"Standard Break"),e(),i(25,"mat-option",16),n(26,"Emergency"),e(),i(27,"mat-option",17),n(28,"Planned Rotation"),e(),i(29,"mat-option",18),n(30,"Other"),e()(),c(31,Sr,2,0,"mat-error",12),e(),c(32,Mr,6,1,"ng-container",12),e(),i(33,"div",19)(34,"button",20),n(35," Next "),i(36,"mat-icon"),n(37,"arrow_forward"),e()()()()(),i(38,"mat-step",6),c(39,Fr,1,0,"ng-template",7),i(40,"form",8)(41,"div",9)(42,"h3"),n(43,"Select New Driver"),e(),c(44,Tr,3,2,"div",21)(45,Ir,3,0,"div",22),e(),i(46,"div",19)(47,"button",23)(48,"mat-icon"),n(49,"arrow_back"),e(),n(50," Back "),e(),i(51,"button",20),n(52," Next "),i(53,"mat-icon"),n(54,"arrow_forward"),e()()()()(),i(55,"mat-step"),c(56,Pr,1,0,"ng-template",7),i(57,"div",9)(58,"h3"),n(59,"Signature Confirmation"),e(),i(60,"div",24)(61,"div",25)(62,"h4"),n(63,"Current Driver's Signature"),e(),i(64,"div",26),p(65,"canvas",27,1),e(),i(67,"div",28)(68,"button",29),D("click",function(){return E(d),S(m.clearSignature("current"))}),n(69," Clear "),e()()(),i(70,"div",25)(71,"h4"),n(72,"New Driver's Signature"),e(),i(73,"div",26),p(74,"canvas",27,2),e(),i(76,"div",28)(77,"button",29),D("click",function(){return E(d),S(m.clearSignature("new"))}),n(78," Clear "),e()()()(),i(79,"div",30)(80,"div",31)(81,"mat-checkbox",32),n(82," Skip signatures (requires notes) "),e()(),c(83,Nr,5,2,"mat-form-field",33),e()(),i(84,"div",19)(85,"button",23)(86,"mat-icon"),n(87,"arrow_back"),e(),n(88," Back "),e(),i(89,"button",34),D("click",function(){return E(d),S(m.completeHandover())}),c(90,qr,1,0,"mat-spinner",35)(91,Or,4,0,"span",12),e()()()()()}if(o&2){let d,u,g,_;a(3),l("linear",!0),a(2),l("stepControl",m.handoverDetailsForm),a(2),l("formGroup",m.handoverDetailsForm),a(6),l("ngIf",(d=m.handoverDetailsForm.get("odometer"))==null?null:d.hasError("required")),a(5),l("ngIf",(u=m.handoverDetailsForm.get("location"))==null?null:u.hasError("required")),a(13),l("ngIf",(g=m.handoverDetailsForm.get("reason"))==null?null:g.hasError("required")),a(),l("ngIf",((_=m.handoverDetailsForm.get("reason"))==null?null:_.value)==="Other"),a(2),l("disabled",m.handoverDetailsForm.invalid),a(4),l("stepControl",m.driverSelectionForm),a(2),l("formGroup",m.driverSelectionForm),a(4),l("ngIf",m.teamMembers.length>0),a(),l("ngIf",m.teamMembers.length===0),a(6),l("disabled",m.driverSelectionForm.invalid),a(30),l("formControl",m.skipSignaturesControl),a(2),l("ngIf",m.skipSignaturesControl.value),a(6),l("disabled",m.submitDisabled||m.saving),a(),l("ngIf",m.saving),a(),l("ngIf",!m.saving)}},dependencies:[Z,K,Q,oe,ee,z,te,X,W,at,re,ie,Ee,Bt,Ht,Se,Zt,Qt,Yt,zt,Xt,fe,ue,ce,de,le,me,pe,se,ye,xe,Ce,ge,_e,nr,ir,rr,ae,he,ve],styles:["[_nghost-%COMP%]{display:block;width:100%;max-width:600px}.mat-mdc-dialog-title[_ngcontent-%COMP%]{color:#4a3c31}.mat-vertical-stepper[_ngcontent-%COMP%]{background-color:transparent}.step-content[_ngcontent-%COMP%]{margin-top:16px;margin-bottom:16px}.step-content[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#4a3c31;margin-top:0;margin-bottom:16px}.step-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-top:24px}.step-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{margin-left:auto}.driver-list-container[_ngcontent-%COMP%]{max-height:300px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:4px}.driver-option[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.driver-info[_ngcontent-%COMP%]{display:flex;flex-direction:column}.driver-name[_ngcontent-%COMP%]{font-weight:500}.driver-role[_ngcontent-%COMP%]{font-size:12px;color:#666}.selection-icon[_ngcontent-%COMP%]{color:#c19a6b}.no-drivers[_ngcontent-%COMP%]{padding:16px;text-align:center;color:#666;font-style:italic;background-color:#f5f5f5;border-radius:4px}.signatures-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:24px;margin-bottom:24px}@media (min-width: 768px){.signatures-container[_ngcontent-%COMP%]{flex-direction:row}}.signature-section[_ngcontent-%COMP%]{flex:1}.signature-section[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin-top:0;margin-bottom:8px;color:#4a3c31}.signature-box[_ngcontent-%COMP%]{width:100%;height:150px;border:1px solid #e0e0e0;border-radius:4px;margin-bottom:8px;overflow:hidden}.signature-box[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;height:100%;background-color:#fff}.signature-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.skip-signature-section[_ngcontent-%COMP%]{margin-top:16px;padding-top:16px;border-top:1px solid #e0e0e0}.skip-checkbox-container[_ngcontent-%COMP%]{margin-bottom:16px}.skip-notes-field[_ngcontent-%COMP%]{width:100%}"]})};function jr(r,t){if(r&1){let o=P();i(0,"div",11)(1,"button",12),D("click",function(){E(o);let d=b();return S(d.openHandoverDialog())}),i(2,"mat-icon"),n(3,"swap_horiz"),e(),n(4," Initiate Handover "),e()()}}function Jr(r,t){r&1&&(i(0,"div",13),p(1,"mat-spinner",14),e())}function Rr(r,t){r&1&&(i(0,"mat-error"),n(1," Shipping Reference is required "),e())}function Ar(r,t){if(r&1&&(i(0,"mat-option",62),n(1),e()),r&2){let o=t.$implicit;l("value",o),a(),N(" ",o," ")}}function Br(r,t){r&1&&(i(0,"mat-error"),n(1," Vehicle type is required "),e())}function Hr(r,t){r&1&&(i(0,"mat-error"),n(1," Make is required "),e())}function Vr(r,t){r&1&&(i(0,"mat-error"),n(1," Model is required "),e())}function Gr(r,t){r&1&&(i(0,"mat-error"),n(1," Registration is required "),e())}function Lr(r,t){r&1&&(i(0,"mat-error"),n(1," Year is required "),e())}function $r(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid year "),e())}function Ur(r,t){if(r&1&&(i(0,"mat-option",62),n(1),e()),r&2){let o=t.$implicit;l("value",o.companyName),a(),rt(" ",o.companyName," (",o.city,") ")}}function Kr(r,t){if(r&1){let o=P();i(0,"button",63),D("click",function(){let d=E(o).$implicit,u=b(2);return S(u.fillAddressFields("collectionDetails",d))}),n(1),e()}if(r&2){let o=t.$implicit;a(),Ie(" ",o.companyName," - ",o.city,", ",o.postcode," ")}}function Qr(r,t){r&1&&(i(0,"mat-error"),n(1," Building number/name is required "),e())}function Zr(r,t){r&1&&(i(0,"mat-error"),n(1," Street is required "),e())}function Yr(r,t){r&1&&(i(0,"mat-error"),n(1," City is required "),e())}function zr(r,t){r&1&&(i(0,"mat-error"),n(1," Postcode is required "),e())}function Xr(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK postcode "),e())}function Wr(r,t){r&1&&(i(0,"mat-error"),n(1," Country is required "),e())}function ei(r,t){r&1&&(i(0,"mat-error"),n(1," Collection date is required "),e())}function ti(r,t){r&1&&(i(0,"mat-error"),n(1," Contact name is required "),e())}function ri(r,t){r&1&&(i(0,"mat-error"),n(1," Contact phone is required "),e())}function ii(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK phone number "),e())}function ni(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid email "),e())}function oi(r,t){if(r&1){let o=P();i(0,"button",63),D("click",function(){let d=E(o).$implicit,u=b(2);return S(u.fillAddressFields("deliveryDetails",d))}),n(1),e()}if(r&2){let o=t.$implicit;a(),Ie(" ",o.companyName," - ",o.city,", ",o.postcode," ")}}function ai(r,t){r&1&&(i(0,"mat-error"),n(1," Building number/name is required "),e())}function li(r,t){r&1&&(i(0,"mat-error"),n(1," Street is required "),e())}function mi(r,t){r&1&&(i(0,"mat-error"),n(1," City is required "),e())}function di(r,t){r&1&&(i(0,"mat-error"),n(1," Postcode is required "),e())}function ci(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK postcode "),e())}function si(r,t){r&1&&(i(0,"mat-error"),n(1," Country is required "),e())}function pi(r,t){r&1&&(i(0,"mat-error"),n(1," Delivery date is required "),e())}function ui(r,t){r&1&&(i(0,"mat-error"),n(1," Contact name is required "),e())}function fi(r,t){r&1&&(i(0,"mat-error"),n(1," Contact phone is required "),e())}function _i(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK phone number "),e())}function gi(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid email "),e())}function vi(r,t){if(r&1){let o=P();i(0,"button",70),D("click",function(){E(o);let d=b().index,u=b(3);return S(u.removeSecondaryPoint(d))}),i(1,"mat-icon"),n(2,"delete"),e()()}}function hi(r,t){r&1&&(i(0,"mat-error"),n(1," Building number/name is required "),e())}function bi(r,t){r&1&&(i(0,"mat-error"),n(1," Street is required "),e())}function Ci(r,t){r&1&&(i(0,"mat-error"),n(1," City is required "),e())}function xi(r,t){r&1&&(i(0,"mat-error"),n(1," Postcode is required "),e())}function yi(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK postcode "),e())}function Ei(r,t){r&1&&(i(0,"mat-error"),n(1," Country is required "),e())}function Si(r,t){r&1&&(i(0,"mat-error"),n(1," Contact name is required "),e())}function Di(r,t){r&1&&(i(0,"mat-error"),n(1," Contact phone is required "),e())}function Mi(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid UK phone number "),e())}function Fi(r,t){r&1&&(i(0,"mat-error"),n(1," Please enter a valid email "),e())}function wi(r,t){if(r&1&&(i(0,"mat-card",67)(1,"mat-card-header")(2,"mat-card-title"),n(3),e(),c(4,vi,3,0,"button",68),e(),i(5,"mat-card-content")(6,"div",31)(7,"mat-form-field",23)(8,"mat-label"),n(9,"Building Number/Name"),e(),p(10,"input",44),c(11,hi,2,0,"mat-error",26),e(),i(12,"mat-form-field",23)(13,"mat-label"),n(14,"Street"),e(),p(15,"input",45),c(16,bi,2,0,"mat-error",26),e()(),i(17,"div",31)(18,"mat-form-field",23)(19,"mat-label"),n(20,"City"),e(),p(21,"input",46),c(22,Ci,2,0,"mat-error",26),e(),i(23,"mat-form-field",23)(24,"mat-label"),n(25,"Postcode"),e(),p(26,"input",47),c(27,xi,2,0,"mat-error",26)(28,yi,2,0,"mat-error",26),e()(),i(29,"div",31)(30,"mat-form-field",23)(31,"mat-label"),n(32,"Country"),e(),p(33,"input",48),c(34,Ei,2,0,"mat-error",26),e(),i(35,"mat-form-field",23)(36,"mat-label"),n(37,"Contact Name"),e(),p(38,"input",51),c(39,Si,2,0,"mat-error",26),e()(),i(40,"div",31)(41,"mat-form-field",23)(42,"mat-label"),n(43,"Contact Phone"),e(),p(44,"input",52),c(45,Di,2,0,"mat-error",26)(46,Mi,2,0,"mat-error",26),e(),i(47,"mat-form-field",23)(48,"mat-label"),n(49,"Contact Email"),e(),p(50,"input",53),c(51,Fi,2,0,"mat-error",26),e()(),i(52,"div",18)(53,"mat-form-field",23)(54,"mat-label"),n(55,"Special Instructions"),e(),p(56,"textarea",69),e()()()()),r&2){let o,m,d,u,g,_,v,h,C,M,x=t.$implicit,L=t.index,$=b(3);l("formGroup",x),a(3),N("Secondary Point ",L+1,""),a(),l("ngIf",$.secondaryPoints.length>1),a(7),l("ngIf",(o=x.get("building"))==null?null:o.hasError("required")),a(5),l("ngIf",(m=x.get("street"))==null?null:m.hasError("required")),a(6),l("ngIf",(d=x.get("city"))==null?null:d.hasError("required")),a(5),l("ngIf",(u=x.get("postcode"))==null?null:u.hasError("required")),a(),l("ngIf",(g=x.get("postcode"))==null?null:g.hasError("pattern")),a(6),l("ngIf",(_=x.get("country"))==null?null:_.hasError("required")),a(5),l("ngIf",(v=x.get("contactName"))==null?null:v.hasError("required")),a(6),l("ngIf",(h=x.get("contactPhone"))==null?null:h.hasError("required")),a(),l("ngIf",(C=x.get("contactPhone"))==null?null:C.hasError("pattern")),a(5),l("ngIf",(M=x.get("contactEmail"))==null?null:M.hasError("email"))}}function Ti(r,t){if(r&1){let o=P();F(0),c(1,wi,57,13,"mat-card",64),i(2,"div",65)(3,"button",66),D("click",function(){E(o);let d=b(2);return S(d.addSecondaryPoint())}),i(4,"mat-icon"),n(5,"add"),e(),n(6," Add Secondary Point "),e()(),w()}if(r&2){let o=b(2);a(),l("ngForOf",o.secondaryPoints.controls)}}function Ii(r,t){if(r&1&&(i(0,"mat-option",62),n(1),e()),r&2){let o=t.$implicit;l("value",o),a(),A(o)}}function Pi(r,t){r&1&&(i(0,"mat-error"),n(1," Team assignment is required "),e())}function ki(r,t){r&1&&(i(0,"th",81),n(1,"Driver"),e())}function Ni(r,t){r&1&&(i(0,"span",84),n(1,"(Current)"),e())}function qi(r,t){if(r&1&&(i(0,"td",82),n(1),c(2,Ni,2,0,"span",83),e()),r&2){let o=t.$implicit;J("current-driver",o.isCurrent),a(),N(" ",o.driverName," "),a(),l("ngIf",o.isCurrent)}}function Oi(r,t){r&1&&(i(0,"th",81),n(1,"Start Time"),e())}function ji(r,t){if(r&1&&(i(0,"td",82),n(1),e()),r&2){let o=t.$implicit,m=b(3);J("current-driver",o.isCurrent),a(),N(" ",m.formatDate(o.startTime)," ")}}function Ji(r,t){r&1&&(i(0,"th",81),n(1,"End Time"),e())}function Ri(r,t){if(r&1&&(i(0,"td",82),n(1),e()),r&2){let o=t.$implicit,m=b(3);J("current-driver",o.isCurrent),a(),N(" ",o.endTime?m.formatDate(o.endTime):"Active"," ")}}function Ai(r,t){r&1&&(i(0,"th",81),n(1,"Notes"),e())}function Bi(r,t){if(r&1&&(i(0,"td",82),n(1),e()),r&2){let o=t.$implicit;J("current-driver",o.isCurrent),a(),N(" ",o.notes," ")}}function Hi(r,t){r&1&&(i(0,"th",81),n(1,"Status"),e())}function Vi(r,t){r&1&&(i(0,"mat-icon",86),n(1,"check_circle"),e())}function Gi(r,t){if(r&1&&(i(0,"td",82),c(1,Vi,2,0,"mat-icon",85),e()),r&2){let o=t.$implicit;J("current-driver",o.isCurrent),a(),l("ngIf",o.isCurrent)}}function Li(r,t){r&1&&p(0,"tr",87)}function $i(r,t){r&1&&p(0,"tr",88)}function Ui(r,t){if(r&1&&(F(0),i(1,"mat-card",16)(2,"mat-card-header")(3,"mat-card-title"),n(4,"Driver Timeline"),e()(),i(5,"mat-card-content")(6,"table",71),F(7,72),c(8,ki,2,0,"th",73)(9,qi,3,4,"td",74),w(),F(10,75),c(11,Oi,2,0,"th",73)(12,ji,2,3,"td",74),w(),F(13,76),c(14,Ji,2,0,"th",73)(15,Ri,2,3,"td",74),w(),F(16,77),c(17,Ai,2,0,"th",73)(18,Bi,2,3,"td",74),w(),F(19,78),c(20,Hi,2,0,"th",73)(21,Gi,2,3,"td",74),w(),c(22,Li,1,0,"tr",79)(23,$i,1,0,"tr",80),e()()(),w()),r&2){let o=b(2);a(6),l("dataSource",o.driverTimeline),a(16),l("matHeaderRowDef",o.displayedColumns),a(),l("matRowDefColumns",o.displayedColumns)}}function Ki(r,t){r&1&&p(0,"mat-spinner",89)}function Qi(r,t){if(r&1&&(i(0,"span")(1,"mat-icon"),n(2,"save"),e(),n(3),e()),r&2){let o=b(2);a(3),N(" ",o.isEditMode?"Update":"Create"," Job ")}}function Zi(r,t){if(r&1){let o=P();i(0,"form",15),D("ngSubmit",function(){E(o);let d=b();return S(d.onSubmit())}),i(1,"mat-card",16)(2,"mat-card-header")(3,"mat-card-title"),n(4,"Job Details"),e()(),i(5,"mat-card-content")(6,"div",17)(7,"div",18)(8,"label",19),n(9,"Job Type"),e(),i(10,"mat-radio-group",20)(11,"mat-radio-button",21),n(12,"Standard"),e(),i(13,"mat-radio-button",22),n(14,"Split Journey"),e()()(),i(15,"div",18)(16,"mat-form-field",23)(17,"mat-label"),n(18,"Customer Reference"),e(),p(19,"input",24),e()(),i(20,"div",18)(21,"mat-form-field",23)(22,"mat-label"),n(23,"Shipping Reference"),e(),p(24,"input",25),c(25,Rr,2,0,"mat-error",26),e()(),i(26,"div",27)(27,"label",28),n(28,"Priority Job"),e(),p(29,"mat-slide-toggle",29),e()()()(),i(30,"mat-card",30)(31,"mat-card-header")(32,"mat-card-title"),n(33,"Vehicle Details"),e()(),i(34,"mat-card-content")(35,"div",31)(36,"mat-form-field",23)(37,"mat-label"),n(38,"Vehicle Type"),e(),i(39,"mat-select",32),c(40,Ar,2,2,"mat-option",33),e(),c(41,Br,2,0,"mat-error",26),e(),i(42,"mat-form-field",23)(43,"mat-label"),n(44,"Make"),e(),p(45,"input",34),c(46,Hr,2,0,"mat-error",26),e()(),i(47,"div",31)(48,"mat-form-field",23)(49,"mat-label"),n(50,"Model"),e(),p(51,"input",35),c(52,Vr,2,0,"mat-error",26),e(),i(53,"mat-form-field",23)(54,"mat-label"),n(55,"Registration"),e(),p(56,"input",36),c(57,Gr,2,0,"mat-error",26),e()(),i(58,"div",31)(59,"mat-form-field",23)(60,"mat-label"),n(61,"Year"),e(),p(62,"input",37),c(63,Lr,2,0,"mat-error",26)(64,$r,2,0,"mat-error",26),e(),i(65,"mat-form-field",23)(66,"mat-label"),n(67,"Location"),e(),p(68,"input",38),i(69,"mat-autocomplete",null,0),c(71,Ur,2,3,"mat-option",33),e()()()()(),i(72,"mat-card",39)(73,"mat-card-header")(74,"mat-card-title"),n(75,"Collection Details"),e()(),i(76,"mat-card-content")(77,"div",40)(78,"span",41),n(79,"Fill from saved address:"),e(),i(80,"button",42)(81,"mat-icon"),n(82,"location_on"),e(),n(83," Select Address "),e(),i(84,"mat-menu",null,1),c(86,Kr,2,3,"button",43),e()(),i(87,"div",31)(88,"mat-form-field",23)(89,"mat-label"),n(90,"Building Number/Name"),e(),p(91,"input",44),c(92,Qr,2,0,"mat-error",26),e(),i(93,"mat-form-field",23)(94,"mat-label"),n(95,"Street"),e(),p(96,"input",45),c(97,Zr,2,0,"mat-error",26),e()(),i(98,"div",31)(99,"mat-form-field",23)(100,"mat-label"),n(101,"City"),e(),p(102,"input",46),c(103,Yr,2,0,"mat-error",26),e(),i(104,"mat-form-field",23)(105,"mat-label"),n(106,"Postcode"),e(),p(107,"input",47),c(108,zr,2,0,"mat-error",26)(109,Xr,2,0,"mat-error",26),e()(),i(110,"div",31)(111,"mat-form-field",23)(112,"mat-label"),n(113,"Country"),e(),p(114,"input",48),c(115,Wr,2,0,"mat-error",26),e(),i(116,"mat-form-field",23)(117,"mat-label"),n(118,"Collection Date"),e(),p(119,"input",49)(120,"mat-datepicker-toggle",50)(121,"mat-datepicker",null,2),c(123,ei,2,0,"mat-error",26),e()(),i(124,"div",31)(125,"mat-form-field",23)(126,"mat-label"),n(127,"Contact Name"),e(),p(128,"input",51),c(129,ti,2,0,"mat-error",26),e(),i(130,"mat-form-field",23)(131,"mat-label"),n(132,"Contact Phone"),e(),p(133,"input",52),c(134,ri,2,0,"mat-error",26)(135,ii,2,0,"mat-error",26),e()(),i(136,"div",18)(137,"mat-form-field",23)(138,"mat-label"),n(139,"Contact Email"),e(),p(140,"input",53),c(141,ni,2,0,"mat-error",26),e()(),i(142,"div",18)(143,"mat-form-field",23)(144,"mat-label"),n(145,"Special Instructions"),e(),p(146,"textarea",54),e()()()(),i(147,"mat-card",55)(148,"mat-card-header")(149,"mat-card-title"),n(150,"Delivery Details"),e()(),i(151,"mat-card-content")(152,"div",40)(153,"span",41),n(154,"Fill from saved address:"),e(),i(155,"button",42)(156,"mat-icon"),n(157,"location_on"),e(),n(158," Select Address "),e(),i(159,"mat-menu",null,3),c(161,oi,2,3,"button",43),e()(),i(162,"div",31)(163,"mat-form-field",23)(164,"mat-label"),n(165,"Building Number/Name"),e(),p(166,"input",44),c(167,ai,2,0,"mat-error",26),e(),i(168,"mat-form-field",23)(169,"mat-label"),n(170,"Street"),e(),p(171,"input",45),c(172,li,2,0,"mat-error",26),e()(),i(173,"div",31)(174,"mat-form-field",23)(175,"mat-label"),n(176,"City"),e(),p(177,"input",46),c(178,mi,2,0,"mat-error",26),e(),i(179,"mat-form-field",23)(180,"mat-label"),n(181,"Postcode"),e(),p(182,"input",47),c(183,di,2,0,"mat-error",26)(184,ci,2,0,"mat-error",26),e()(),i(185,"div",31)(186,"mat-form-field",23)(187,"mat-label"),n(188,"Country"),e(),p(189,"input",48),c(190,si,2,0,"mat-error",26),e(),i(191,"mat-form-field",23)(192,"mat-label"),n(193,"Delivery Date"),e(),p(194,"input",49)(195,"mat-datepicker-toggle",50)(196,"mat-datepicker",null,4),c(198,pi,2,0,"mat-error",26),e()(),i(199,"div",31)(200,"mat-form-field",23)(201,"mat-label"),n(202,"Contact Name"),e(),p(203,"input",51),c(204,ui,2,0,"mat-error",26),e(),i(205,"mat-form-field",23)(206,"mat-label"),n(207,"Contact Phone"),e(),p(208,"input",52),c(209,fi,2,0,"mat-error",26)(210,_i,2,0,"mat-error",26),e()(),i(211,"div",18)(212,"mat-form-field",23)(213,"mat-label"),n(214,"Contact Email"),e(),p(215,"input",53),c(216,gi,2,0,"mat-error",26),e()(),i(217,"div",18)(218,"mat-form-field",23)(219,"mat-label"),n(220,"Special Instructions"),e(),p(221,"textarea",54),e()()()(),c(222,Ti,7,1,"ng-container",26),i(223,"mat-card",16)(224,"mat-card-header")(225,"mat-card-title"),n(226,"Team Assignment"),e()(),i(227,"mat-card-content")(228,"div",18)(229,"mat-form-field",23)(230,"mat-label"),n(231,"Team"),e(),i(232,"mat-select",56)(233,"mat-option",57),n(234,"Unassigned"),e(),c(235,Ii,2,2,"mat-option",33),e(),c(236,Pi,2,0,"mat-error",26),e()()()(),c(237,Ui,24,3,"ng-container",26),i(238,"div",58)(239,"button",59),D("click",function(){E(o);let d=b();return S(d.onCancel())}),i(240,"mat-icon"),n(241,"cancel"),e(),n(242," Cancel "),e(),i(243,"button",60),c(244,Ki,1,0,"mat-spinner",61)(245,Qi,4,1,"span",26),e()()()}if(r&2){let o,m,d,u,g,_,v,h,C,M,x,L,$,qe,Oe,je,Je,Re,Ae,Be,He,Ve,Ge,Le,$e,Ue,Ke,Qe,Ze,Ye,ze,ar=R(70),lr=R(85),Xe=R(122),mr=R(160),We=R(197),f=b();l("formGroup",f.jobForm),a(25),l("ngIf",(o=f.jobForm.get("shippingReference"))==null?null:o.hasError("required")),a(15),l("ngForOf",f.vehicleTypes),a(),l("ngIf",(m=f.jobForm.get("vehicleDetails.type"))==null?null:m.hasError("required")),a(5),l("ngIf",(d=f.jobForm.get("vehicleDetails.make"))==null?null:d.hasError("required")),a(6),l("ngIf",(u=f.jobForm.get("vehicleDetails.model"))==null?null:u.hasError("required")),a(5),l("ngIf",(g=f.jobForm.get("vehicleDetails.registration"))==null?null:g.hasError("required")),a(6),l("ngIf",(_=f.jobForm.get("vehicleDetails.year"))==null?null:_.hasError("required")),a(),l("ngIf",((v=f.jobForm.get("vehicleDetails.year"))==null?null:v.hasError("min"))||((v=f.jobForm.get("vehicleDetails.year"))==null?null:v.hasError("max"))),a(4),l("matAutocomplete",ar),a(3),l("ngForOf",f.addressOptions),a(9),l("matMenuTriggerFor",lr),a(6),l("ngForOf",f.addressOptions),a(6),l("ngIf",(h=f.jobForm.get("collectionDetails.building"))==null?null:h.hasError("required")),a(5),l("ngIf",(C=f.jobForm.get("collectionDetails.street"))==null?null:C.hasError("required")),a(6),l("ngIf",(M=f.jobForm.get("collectionDetails.city"))==null?null:M.hasError("required")),a(5),l("ngIf",(x=f.jobForm.get("collectionDetails.postcode"))==null?null:x.hasError("required")),a(),l("ngIf",(L=f.jobForm.get("collectionDetails.postcode"))==null?null:L.hasError("pattern")),a(6),l("ngIf",($=f.jobForm.get("collectionDetails.country"))==null?null:$.hasError("required")),a(4),l("matDatepicker",Xe),a(),l("for",Xe),a(3),l("ngIf",(qe=f.jobForm.get("collectionDetails.date"))==null?null:qe.hasError("required")),a(6),l("ngIf",(Oe=f.jobForm.get("collectionDetails.contactName"))==null?null:Oe.hasError("required")),a(5),l("ngIf",(je=f.jobForm.get("collectionDetails.contactPhone"))==null?null:je.hasError("required")),a(),l("ngIf",(Je=f.jobForm.get("collectionDetails.contactPhone"))==null?null:Je.hasError("pattern")),a(6),l("ngIf",(Re=f.jobForm.get("collectionDetails.contactEmail"))==null?null:Re.hasError("email")),a(14),l("matMenuTriggerFor",mr),a(6),l("ngForOf",f.addressOptions),a(6),l("ngIf",(Ae=f.jobForm.get("deliveryDetails.building"))==null?null:Ae.hasError("required")),a(5),l("ngIf",(Be=f.jobForm.get("deliveryDetails.street"))==null?null:Be.hasError("required")),a(6),l("ngIf",(He=f.jobForm.get("deliveryDetails.city"))==null?null:He.hasError("required")),a(5),l("ngIf",(Ve=f.jobForm.get("deliveryDetails.postcode"))==null?null:Ve.hasError("required")),a(),l("ngIf",(Ge=f.jobForm.get("deliveryDetails.postcode"))==null?null:Ge.hasError("pattern")),a(6),l("ngIf",(Le=f.jobForm.get("deliveryDetails.country"))==null?null:Le.hasError("required")),a(4),l("matDatepicker",We),a(),l("for",We),a(3),l("ngIf",($e=f.jobForm.get("deliveryDetails.date"))==null?null:$e.hasError("required")),a(6),l("ngIf",(Ue=f.jobForm.get("deliveryDetails.contactName"))==null?null:Ue.hasError("required")),a(5),l("ngIf",(Ke=f.jobForm.get("deliveryDetails.contactPhone"))==null?null:Ke.hasError("required")),a(),l("ngIf",(Qe=f.jobForm.get("deliveryDetails.contactPhone"))==null?null:Qe.hasError("pattern")),a(6),l("ngIf",(Ze=f.jobForm.get("deliveryDetails.contactEmail"))==null?null:Ze.hasError("email")),a(6),l("ngIf",((Ye=f.jobForm.get("jobType"))==null?null:Ye.value)==="Split Journey"),a(13),l("ngForOf",f.teams),a(),l("ngIf",(ze=f.jobForm.get("team"))==null?null:ze.hasError("required")),a(),l("ngIf",f.isEditMode&&f.driverTimeline.length>0),a(6),l("disabled",f.saving),a(),l("ngIf",f.saving),a(),l("ngIf",!f.saving)}}var or=class r{formBuilder=y(ne);firestore=y(Y);route=y(it);router=y(nt);snackBar=y(be);dialog=y(At);jobForm;isEditMode=!1;loading=!0;saving=!1;jobId=null;driverTimeline=[];displayedColumns=["driverName","startTime","endTime","notes","current"];teams=[];vehicleTypes=["Car","Van","Truck","Motorcycle"];addressOptions=[];isSuperAdmin=!0;subscriptions=[];ngOnInit(){this.initializeForm(),this.loadTeams(),this.loadAddresses(),this.route.paramMap.subscribe(t=>{this.jobId=t.get("id"),this.jobId?(this.isEditMode=!0,this.loadJobData(this.jobId)):this.loading=!1})}ngOnDestroy(){this.subscriptions.forEach(t=>t.unsubscribe())}initializeForm(){this.jobForm=this.formBuilder.group({jobType:["Standard",s.required],customerReference:[""],shippingReference:["",s.required],priority:[!1],vehicleDetails:this.formBuilder.group({type:["",s.required],make:["",s.required],model:["",s.required],registration:["",s.required],year:[new Date().getFullYear(),[s.required,s.min(1900),s.max(2100)]],location:[""]}),collectionDetails:this.formBuilder.group({building:["",s.required],street:["",s.required],city:["",s.required],postcode:["",[s.required,s.pattern(/^([A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2})$/)]],country:["United Kingdom",s.required],contactName:["",s.required],contactPhone:["",[s.required,s.pattern(/^(\+44|0)\d{10}$/)]],contactEmail:["",[s.email]],instructions:[""],date:[new Date,s.required]}),deliveryDetails:this.formBuilder.group({building:["",s.required],street:["",s.required],city:["",s.required],postcode:["",[s.required,s.pattern(/^([A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2})$/)]],country:["United Kingdom",s.required],contactName:["",s.required],contactPhone:["",[s.required,s.pattern(/^(\+44|0)\d{10}$/)]],contactEmail:["",[s.email]],instructions:[""],date:[new Date(Date.now()+864e5),s.required]}),secondaryPoints:this.formBuilder.array([]),team:["",s.required]}),this.jobForm.get("jobType")?.valueChanges.subscribe(t=>{t==="Split Journey"&&this.ensureSecondaryPoint()})}createSecondaryPointGroup(){return this.formBuilder.group({building:["",s.required],street:["",s.required],city:["",s.required],postcode:["",[s.required,s.pattern(/^([A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2})$/)]],country:["United Kingdom",s.required],contactName:["",s.required],contactPhone:["",[s.required,s.pattern(/^(\+44|0)\d{10}$/)]],contactEmail:["",[s.email]],instructions:[""]})}get secondaryPoints(){return this.jobForm.get("secondaryPoints")}ensureSecondaryPoint(){this.secondaryPoints.length===0&&this.addSecondaryPoint()}addSecondaryPoint(){this.secondaryPoints.push(this.createSecondaryPointGroup())}removeSecondaryPoint(t){this.secondaryPoints.removeAt(t)}loadTeams(){try{let t=I(this.firestore,"Teams"),o=q(t,ke("name")),m=Pe(o,{idField:"id"}).subscribe({next:d=>{this.teams=d.map(u=>u.name)},error:d=>{console.error("Error loading teams:",d),this.snackBar.open("Error loading teams. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]})}});this.subscriptions.push(m)}catch(t){console.error("Error setting up teams subscription:",t)}}loadAddresses(){try{let t=I(this.firestore,"Addresses"),o=q(t),m=Pe(o,{idField:"id"}).subscribe({next:d=>{this.addressOptions=d},error:d=>{console.error("Error loading addresses:",d)}});this.subscriptions.push(m)}catch(t){console.error("Error setting up addresses subscription:",t)}}loadJobData(t){return k(this,null,function*(){try{let o=j(this.firestore,"Jobs",t),m=yield V(o);if(m.exists()){let d=m.data();this.jobForm.patchValue({jobType:d.jobType||"Standard",customerReference:d.customerReference||"",shippingReference:d.shippingReference||"",priority:d.priority||!1,vehicleDetails:{type:d.vehicleType||"",make:d.vehicleMake||"",model:d.vehicleModel||"",registration:d.vehicleRegistration||"",year:d.vehicleYear||new Date().getFullYear(),location:d.vehicleLocation||""},collectionDetails:{building:d.collectionBuilding||"",street:d.collectionStreet||"",city:d.collectionCity||"",postcode:d.collectionPostcode||"",country:d.collectionCountry||"United Kingdom",contactName:d.collectionContactName||"",contactPhone:d.collectionContactPhone||"",contactEmail:d.collectionContactEmail||"",instructions:d.collectionInstructions||"",date:d.collectionDate?.toDate()||new Date},deliveryDetails:{building:d.deliveryBuilding||"",street:d.deliveryStreet||"",city:d.deliveryCity||"",postcode:d.deliveryPostcode||"",country:d.deliveryCountry||"United Kingdom",contactName:d.deliveryContactName||"",contactPhone:d.deliveryContactPhone||"",contactEmail:d.deliveryContactEmail||"",instructions:d.deliveryInstructions||"",date:d.deliveryDate?.toDate()||new Date(Date.now()+864e5)},team:d.team||""}),d.jobType==="Split Journey"&&d.secondaryPoints?.length>0&&(this.secondaryPoints.clear(),d.secondaryPoints.forEach(u=>{this.secondaryPoints.push(this.formBuilder.group({building:[u.building||"",s.required],street:[u.street||"",s.required],city:[u.city||"",s.required],postcode:[u.postcode||"",[s.required,s.pattern(/^([A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2})$/)]],country:[u.country||"United Kingdom",s.required],contactName:[u.contactName||"",s.required],contactPhone:[u.contactPhone||"",[s.required,s.pattern(/^(\+44|0)\d{10}$/)]],contactEmail:[u.contactEmail||"",[s.email]],instructions:[u.instructions||""]}))})),yield this.loadDriverTimeline(t),this.loading=!1}else this.snackBar.open("Job not found.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.router.navigate(["/jobs"])}catch(o){console.error("Error loading job data:",o),this.snackBar.open("Error loading job data. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.loading=!1}})}loadDriverTimeline(t){return k(this,null,function*(){try{let o=I(this.firestore,"DriverTimeline"),m=q(o,O("jobId","==",t),ke("startTime","desc")),d=yield B(m);this.driverTimeline=[],d.forEach(u=>{let g=u.data();this.driverTimeline.push({id:u.id,driverId:g.driverId,driverName:g.driverName,startTime:g.startTime,endTime:g.endTime,notes:g.notes,isCurrent:g.endTime===null})})}catch(o){console.error("Error loading driver timeline:",o)}})}fillAddressFields(t,o){let m=this.jobForm.get(t);m&&m.patchValue({building:o.building,street:o.street,city:o.city,postcode:o.postcode,country:o.country})}filterAddresses(t){let o=t.toLowerCase();return this.addressOptions.filter(m=>m.companyName.toLowerCase().includes(o)||m.postcode.toLowerCase().includes(o)||m.city.toLowerCase().includes(o))}openHandoverDialog(){if(!this.jobId)return;this.dialog.open(De,{width:"600px",data:{jobId:this.jobId,team:this.jobForm.get("team")?.value}}).afterClosed().subscribe(o=>{o&&o.success&&(this.loadDriverTimeline(this.jobId),this.snackBar.open("Handover completed successfully.","Close",{duration:3e3}))})}onSubmit(){return k(this,null,function*(){if(this.jobForm.invalid){this.markFormGroupTouched(this.jobForm),this.snackBar.open("Please fix the validation errors before submitting.","Close",{duration:5e3,panelClass:["warning-snackbar"]});return}this.saving=!0;try{let t=this.jobForm.value,o=et(Me(Me({jobType:t.jobType,customerReference:t.customerReference,shippingReference:t.shippingReference,priority:t.priority,vehicleType:t.vehicleDetails.type,vehicleMake:t.vehicleDetails.make,vehicleModel:t.vehicleDetails.model,vehicleRegistration:t.vehicleDetails.registration,vehicleYear:t.vehicleDetails.year,vehicleLocation:t.vehicleDetails.location,collectionBuilding:t.collectionDetails.building,collectionStreet:t.collectionDetails.street,collectionCity:t.collectionDetails.city,collectionPostcode:t.collectionDetails.postcode,collectionCountry:t.collectionDetails.country,collectionContactName:t.collectionDetails.contactName,collectionContactPhone:t.collectionDetails.contactPhone,collectionContactEmail:t.collectionDetails.contactEmail,collectionInstructions:t.collectionDetails.instructions,collectionDate:T.fromDate(t.collectionDetails.date),deliveryBuilding:t.deliveryDetails.building,deliveryStreet:t.deliveryDetails.street,deliveryCity:t.deliveryDetails.city,deliveryPostcode:t.deliveryDetails.postcode,deliveryCountry:t.deliveryDetails.country,deliveryContactName:t.deliveryDetails.contactName,deliveryContactPhone:t.deliveryDetails.contactPhone,deliveryContactEmail:t.deliveryDetails.contactEmail,deliveryInstructions:t.deliveryDetails.instructions,deliveryDate:T.fromDate(t.deliveryDetails.date),team:t.team},t.jobType==="Split Journey"&&{secondaryPoints:t.secondaryPoints}),!this.isEditMode&&{status:"Unallocated",createdAt:T.now()}),{updatedAt:T.now()});if(this.isEditMode&&this.jobId){let m=j(this.firestore,"Jobs",this.jobId);yield G(m,o),this.snackBar.open("Job updated successfully.","Close",{duration:3e3})}else{let m=I(this.firestore,"Jobs"),d=yield H(m,o);this.snackBar.open("Job created successfully.","Close",{duration:3e3}),this.router.navigate(["/jobs/edit",d.id])}this.saving=!1}catch(t){console.error("Error saving job:",t),this.snackBar.open("Error saving job. Please try again.","Close",{duration:5e3,panelClass:["error-snackbar"]}),this.saving=!1}})}onCancel(){this.router.navigate(["/jobs"])}markFormGroupTouched(t){Object.values(t.controls).forEach(o=>{o.markAsTouched(),o instanceof Ne?this.markFormGroupTouched(o):o instanceof mt&&o.controls.forEach(m=>{m instanceof Ne?this.markFormGroupTouched(m):m.markAsTouched()})})}formatDate(t){return t?t.toDate().toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"}static \u0275fac=function(o){return new(o||r)};static \u0275cmp=U({type:r,selectors:[["app-job-form"]],decls:7,vars:4,consts:[["locationAuto","matAutocomplete"],["addressMenu","matMenu"],["collectionPicker",""],["deliveryAddressMenu","matMenu"],["deliveryPicker",""],[1,"job-form-container"],[1,"page-header"],[1,"page-title"],["class","header-actions",4,"ngIf"],["class","loading-container",4,"ngIf"],[3,"formGroup","ngSubmit",4,"ngIf"],[1,"header-actions"],["mat-raised-button","","color","primary",1,"handover-button",3,"click"],[1,"loading-container"],["diameter","50"],[3,"ngSubmit","formGroup"],[1,"form-card"],[1,"job-type-section"],[1,"form-row"],[1,"section-label"],["formControlName","jobType",1,"job-type-group"],["value","Standard"],["value","Split Journey"],["appearance","outline"],["matInput","","formControlName","customerReference"],["matInput","","formControlName","shippingReference"],[4,"ngIf"],[1,"form-row","priority-row"],[1,"priority-label"],["formControlName","priority","color","primary"],["formGroupName","vehicleDetails",1,"form-card"],[1,"form-row","row-split"],["formControlName","type"],[3,"value",4,"ngFor","ngForOf"],["matInput","","formControlName","make"],["matInput","","formControlName","model"],["matInput","","formControlName","registration"],["matInput","","formControlName","year","type","number"],["matInput","","formControlName","location",3,"matAutocomplete"],["formGroupName","collectionDetails",1,"form-card"],[1,"address-options"],[1,"address-label"],["type","button","mat-stroked-button","",1,"address-button",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click",4,"ngFor","ngForOf"],["matInput","","formControlName","building"],["matInput","","formControlName","street"],["matInput","","formControlName","city"],["matInput","","formControlName","postcode"],["matInput","","formControlName","country"],["matInput","","formControlName","date",3,"matDatepicker"],["matIconSuffix","",3,"for"],["matInput","","formControlName","contactName"],["matInput","","formControlName","contactPhone"],["matInput","","formControlName","contactEmail","type","email"],["matInput","","formControlName","instructions","rows","3"],["formGroupName","deliveryDetails",1,"form-card"],["formControlName","team"],["value",""],[1,"form-actions"],["type","button","mat-stroked-button","",3,"click"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20",4,"ngIf"],[3,"value"],["mat-menu-item","",3,"click"],["class","form-card",3,"formGroup",4,"ngFor","ngForOf"],[1,"add-secondary-button-container"],["type","button","mat-stroked-button","","color","primary",3,"click"],[1,"form-card",3,"formGroup"],["type","button","mat-icon-button","","color","warn","class","remove-button",3,"click",4,"ngIf"],["matInput","","formControlName","instructions","rows","2"],["type","button","mat-icon-button","","color","warn",1,"remove-button",3,"click"],["mat-table","",1,"driver-timeline-table",3,"dataSource"],["matColumnDef","driverName"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",3,"current-driver",4,"matCellDef"],["matColumnDef","startTime"],["matColumnDef","endTime"],["matColumnDef","notes"],["matColumnDef","current"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell",""],["class","current-label",4,"ngIf"],[1,"current-label"],["class","current-icon",4,"ngIf"],[1,"current-icon"],["mat-header-row",""],["mat-row",""],["diameter","20"]],template:function(o,m){o&1&&(i(0,"div",5)(1,"div",6)(2,"h1",7),n(3),e(),c(4,jr,5,0,"div",8),e(),c(5,Jr,2,0,"div",9)(6,Zi,246,48,"form",10),e()),o&2&&(a(3),A(m.isEditMode?"Edit Job":"Create New Job"),a(),l("ngIf",m.isEditMode&&m.isSuperAdmin),a(),l("ngIf",m.loading),a(),l("ngIf",!m.loading))},dependencies:[Z,K,Q,oe,ee,z,te,X,W,re,ie,lt,ot,ae,dt,st,pt,ct,ce,de,le,me,ut,pe,se,ye,xe,Ce,Lt,Vt,Gt,Ut,$t,fe,ue,ft,ge,_e,he,ve,Kt,_t,Se,tr,Wt,er,Pt,wt,Tt,It,Ft,jt,Mt,gt,ht,yt,bt,vt,Et,Ct,xt,St,Dt,Ee,Ot,Nt,kt,qt],styles:[".job-form-container[_ngcontent-%COMP%]{padding:20px;background-color:#f5f5f5;min-height:100%}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}@media (max-width: 768px){.page-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:16px}}.page-title[_ngcontent-%COMP%]{font-size:24px;font-weight:500;color:#4a3c31;margin:0}.header-actions[_ngcontent-%COMP%]{display:flex;gap:12px}@media (max-width: 768px){.header-actions[_ngcontent-%COMP%]{width:100%}}.handover-button[_ngcontent-%COMP%]{background-color:#c19a6b;color:#fff}.loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:200px}.form-card[_ngcontent-%COMP%]{margin-bottom:24px;border-radius:8px;box-shadow:0 2px 10px #0000001a}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]{padding:16px 16px 0;position:relative}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]   .mat-mdc-card-title[_ngcontent-%COMP%]{color:#4a3c31;font-size:18px;margin-bottom:8px}.form-card[_ngcontent-%COMP%]   .mat-mdc-card-content[_ngcontent-%COMP%]{padding:16px}.form-card[_ngcontent-%COMP%]   .remove-button[_ngcontent-%COMP%]{position:absolute;right:8px;top:8px}.form-row[_ngcontent-%COMP%]{margin-bottom:16px;width:100%}.form-row.row-split[_ngcontent-%COMP%]{display:flex;gap:16px}.form-row.row-split[_ngcontent-%COMP%]   .mat-mdc-form-field[_ngcontent-%COMP%]{flex:1}@media (max-width: 768px){.form-row.row-split[_ngcontent-%COMP%]{flex-direction:column;gap:0}}.form-row.priority-row[_ngcontent-%COMP%]{display:flex;align-items:center}.form-row.priority-row[_ngcontent-%COMP%]   .priority-label[_ngcontent-%COMP%]{margin-right:16px;color:#333;font-weight:500}.section-label[_ngcontent-%COMP%]{margin-bottom:8px;display:block;color:#333;font-weight:500}.job-type-group[_ngcontent-%COMP%]{display:flex;gap:24px;margin-bottom:16px}.address-options[_ngcontent-%COMP%]{display:flex;align-items:center;margin-bottom:16px}.address-options[_ngcontent-%COMP%]   .address-label[_ngcontent-%COMP%]{margin-right:12px;color:#666}.address-options[_ngcontent-%COMP%]   .address-button[_ngcontent-%COMP%]{color:#c19a6b}.add-secondary-button-container[_ngcontent-%COMP%]{display:flex;justify-content:center;margin-bottom:24px}.add-secondary-button-container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:#c19a6b;border-color:#c19a6b}.add-secondary-button-container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#c19a6b0a}.driver-timeline-table[_ngcontent-%COMP%]{width:100%}.driver-timeline-table[_ngcontent-%COMP%]   .mat-mdc-header-cell[_ngcontent-%COMP%]{font-weight:500;color:#4a3c31}.driver-timeline-table[_ngcontent-%COMP%]   .current-driver[_ngcontent-%COMP%]{background-color:#4caf501a;font-weight:500}.driver-timeline-table[_ngcontent-%COMP%]   .current-label[_ngcontent-%COMP%]{margin-left:8px;color:#4caf50;font-size:12px}.driver-timeline-table[_ngcontent-%COMP%]   .current-icon[_ngcontent-%COMP%]{color:#4caf50}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:16px;margin-top:24px;margin-bottom:40px}.form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:120px}@media (max-width: 576px){.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}"]})};export{or as JobFormComponent};
