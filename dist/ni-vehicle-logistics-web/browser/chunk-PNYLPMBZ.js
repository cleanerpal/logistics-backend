import{c as Fe}from"./chunk-MTSSNG6B.js";import{d as Ne}from"./chunk-DWEM3L4R.js";import{a as De,b as ke}from"./chunk-ESJIWLK4.js";import{a as Ee,b as ye,c as je,d as Se,i as we}from"./chunk-PQIIHW7R.js";import"./chunk-GW6WOXIL.js";import{b as fe,c as _e}from"./chunk-LDLE5TDT.js";import"./chunk-U5UIMM6O.js";import"./chunk-PP7BOOB7.js";import{a as ge}from"./chunk-FL7UC7QU.js";import"./chunk-DQFV6XNM.js";import{a as re,b as ae,c as ce,f as me,h as se}from"./chunk-OFY7VGJP.js";import{b as le,c as de,f as pe,i as ue}from"./chunk-P7ITNQJW.js";import{a as he,b as Pe}from"./chunk-HDC6EVXZ.js";import{b as Oe,c as Ie}from"./chunk-Q2NIOR5G.js";import{C as ve,E as xe,H as Ce,I as be,J as Me,b as X,d as C,g as Y,h as Z,l as ee,o as te,q as ne,u as oe,w as ie}from"./chunk-E6Y7ME2X.js";import"./chunk-ZO4V6NUC.js";import{a as V,c as R,g as z}from"./chunk-4PPYA6ZN.js";import{ea as S,ga as $,i as J,j as B,ja as L,ka as P,ma as H,na as Q,o as q,pa as w,ua as U,wa as K,xa as W}from"./chunk-3O2P3FIP.js";import{Cb as s,Lb as i,Mb as n,Nb as g,Ob as E,Pb as y,Rb as F,Vb as b,Wb as u,db as a,ec as N,fc as r,gc as j,hc as v,ib as x,jc as A,pa as M,pb as D,qa as h,sb as k,tc as T,uc as G,vb as p}from"./chunk-NXWLSP6D.js";import{g as I}from"./chunk-RA2WU32H.js";var O=class o{transform(e){return e?.filter(t=>t.approved)||[]}static \u0275fac=function(t){return new(t||o)};static \u0275pipe=k({name:"approvedExpenses",type:o,pure:!0})};function Ge(o,e){o&1&&(i(0,"div",8),g(1,"mat-spinner",9),n())}function Je(o,e){o&1&&(i(0,"mat-error"),r(1," Customer name is required "),n())}function Be(o,e){o&1&&(i(0,"mat-error"),r(1," Email is required "),n())}function qe(o,e){o&1&&(i(0,"mat-error"),r(1," Please enter a valid email address "),n())}function Ve(o,e){o&1&&(i(0,"mat-error"),r(1," Address is required "),n())}function Re(o,e){o&1&&(i(0,"mat-error"),r(1," Due date is required "),n())}function ze(o,e){if(o&1&&(i(0,"div",38)(1,"div",39)(2,"div",40),r(3),n(),i(4,"div",41),r(5),n()(),i(6,"div",42)(7,"div",43),r(8),n(),i(9,"div",44),r(10),n()()()),o&2){let t=e.$implicit,c=u(3);a(3),j(t.id),a(2),v(" ",c.formatCurrency(t.amount||0)," "),a(3),A(" ",t.vehicleMake," ",t.vehicleModel," (",t.vehicleRegistration,") "),a(2),v("Status: ",t.status,"")}}function $e(o,e){o&1&&g(0,"mat-divider")}function Le(o,e){if(o&1&&(i(0,"div",49)(1,"div",50),r(2),n(),i(3,"div",51),r(4),n()()),o&2){let t=e.$implicit,c=u(6);a(2),v(" ",t.description," "),a(2),v(" ",c.formatCurrency(t.amount)," ")}}function He(o,e){if(o&1&&(E(0),p(1,Le,5,2,"div",48),T(2,"approvedExpenses"),y()),o&2){let t=u().$implicit;a(),s("ngForOf",G(2,1,t.expenses))}}function Qe(o,e){if(o&1&&(E(0),p(1,He,3,3,"ng-container",16),y()),o&2){let t=e.$implicit;a(),s("ngIf",t.expenses&&t.expenses.length>0)}}function Ue(o,e){if(o&1&&(i(0,"div",45)(1,"h3"),r(2,"Chargeable Expenses"),n(),i(3,"div",46),p(4,Qe,2,1,"ng-container",47),n()()),o&2){let t=u(3);a(4),s("ngForOf",t.selectedJobs)}}function Ke(o,e){if(o&1&&(i(0,"mat-card",12)(1,"mat-card-header")(2,"mat-card-title"),r(3,"Job Details"),n()(),i(4,"mat-card-content")(5,"div",35),p(6,ze,11,6,"div",36),n(),p(7,$e,1,0,"mat-divider",16)(8,Ue,5,1,"div",37),n()()),o&2){let t=u(2);a(6),s("ngForOf",t.selectedJobs),a(),s("ngIf",t.chargeableExpenses>0),a(),s("ngIf",t.chargeableExpenses>0)}}function We(o,e){if(o&1&&(i(0,"div",25)(1,"div",26),r(2,"Expenses:"),n(),i(3,"div",27),r(4),n()()),o&2){let t=u(2);a(4),v(" ",t.formatCurrency(t.chargeableExpenses)," ")}}function Xe(o,e){o&1&&g(0,"mat-spinner",52)}function Ye(o,e){o&1&&(i(0,"span")(1,"mat-icon"),r(2,"save"),n(),r(3," Save as Draft "),n())}function Ze(o,e){if(o&1){let t=F();i(0,"div",10)(1,"form",11),b("ngSubmit",function(){M(t);let m=u();return h(m.onSubmit())}),i(2,"mat-card",12)(3,"mat-card-header")(4,"mat-card-title"),r(5,"Customer Information"),n()(),i(6,"mat-card-content")(7,"div",13)(8,"mat-form-field",14)(9,"mat-label"),r(10,"Customer Name"),n(),g(11,"input",15),p(12,Je,2,0,"mat-error",16),n()(),i(13,"div",13)(14,"mat-form-field",14)(15,"mat-label"),r(16,"Company Name"),n(),g(17,"input",17),n()(),i(18,"div",13)(19,"mat-form-field",14)(20,"mat-label"),r(21,"Email"),n(),g(22,"input",18),p(23,Be,2,0,"mat-error",16)(24,qe,2,0,"mat-error",16),n()(),i(25,"div",13)(26,"mat-form-field",14)(27,"mat-label"),r(28,"Address"),n(),g(29,"textarea",19),p(30,Ve,2,0,"mat-error",16),n()(),i(31,"div",13)(32,"mat-form-field",14)(33,"mat-label"),r(34,"Due Date"),n(),g(35,"input",20)(36,"mat-datepicker-toggle",21)(37,"mat-datepicker",null,0),p(39,Re,2,0,"mat-error",16),n()()()(),p(40,Ke,9,3,"mat-card",22),i(41,"mat-card",12)(42,"mat-card-header")(43,"mat-card-title"),r(44,"Invoice Summary"),n()(),i(45,"mat-card-content")(46,"div",13)(47,"mat-form-field",14)(48,"mat-label"),r(49,"Notes"),n(),g(50,"textarea",23),n()(),i(51,"div",24)(52,"div",25)(53,"div",26),r(54,"Job Amount:"),n(),i(55,"div",27),r(56),n()(),p(57,We,5,1,"div",28),i(58,"div",29)(59,"div",26),r(60,"Total Amount:"),n(),i(61,"div",27),r(62),n()()()()(),i(63,"div",30)(64,"button",31),b("click",function(){M(t);let m=u();return h(m.cancelInvoice())}),i(65,"mat-icon"),r(66,"cancel"),n(),r(67," Cancel "),n(),i(68,"button",32),b("click",function(){M(t);let m=u();return h(m.sendInvoice())}),i(69,"mat-icon"),r(70,"email"),n(),r(71," Save & Send "),n(),i(72,"button",33),p(73,Xe,1,0,"mat-spinner",34)(74,Ye,4,0,"span",16),n()()()()}if(o&2){let t,c,m,l,f,_=N(38),d=u();a(),s("formGroup",d.invoiceForm),a(11),s("ngIf",(t=d.invoiceForm.get("customerName"))==null?null:t.hasError("required")),a(11),s("ngIf",(c=d.invoiceForm.get("customerEmail"))==null?null:c.hasError("required")),a(),s("ngIf",(m=d.invoiceForm.get("customerEmail"))==null?null:m.hasError("email")),a(6),s("ngIf",(l=d.invoiceForm.get("customerAddress"))==null?null:l.hasError("required")),a(5),s("matDatepicker",_),a(),s("for",_),a(3),s("ngIf",(f=d.invoiceForm.get("dueDate"))==null?null:f.hasError("required")),a(),s("ngIf",d.selectedJobs.length>0),a(16),v(" ",d.formatCurrency(d.jobAmount)," "),a(),s("ngIf",d.chargeableExpenses>0),a(5),j(d.formatCurrency(d.totalAmount)),a(6),s("disabled",d.saving||d.invoiceForm.invalid),a(4),s("disabled",d.saving),a(),s("ngIf",d.saving),a(),s("ngIf",!d.saving)}}var Ae=class o{constructor(e,t,c,m,l){this.formBuilder=e;this.firestore=t;this.route=c;this.router=m;this.snackBar=l;this.initForm()}invoiceForm;selectedJobs=[];jobIds=[];loading=!0;saving=!1;totalAmount=0;chargeableExpenses=0;ngOnInit(){this.route.queryParams.subscribe(e=>{e.jobs?(this.jobIds=e.jobs.split(","),this.loadJobsData()):this.loading=!1})}initForm(){this.invoiceForm=this.formBuilder.group({customerName:["",C.required],customerCompany:[""],customerEmail:["",[C.required,C.email]],customerAddress:["",C.required],dueDate:[this.getDefaultDueDate(),C.required],notes:[""],totalAmount:[{value:0,disabled:!0}]})}getDefaultDueDate(){let e=new Date;return e.setDate(e.getDate()+30),e}loadJobsData(){if(this.jobIds.length===0){this.loading=!1;return}try{let e=P(this.firestore,"Jobs"),t=U(e,W(Q(),"in",this.jobIds));w(t).then(c=>{if(this.selectedJobs=c.docs.map(m=>{let l=m.data();return{id:m.id,vehicleMake:l.vehicleMake||"",vehicleModel:l.vehicleModel||"",vehicleRegistration:l.vehicleRegistration||"",customerName:l.customerName||"",customerCompany:l.customerCompany||"",customerEmail:l.customerEmail||"",customerAddress:l.customerAddress||"",amount:l.amount||0,expenses:l.expenses||[],status:l.status||"",deliveryDate:l.deliveryDate,completedAt:l.completedAt}}),this.calculateTotals(),this.selectedJobs.length>0){let m=this.selectedJobs[0];this.invoiceForm.patchValue({customerName:m.customerName,customerCompany:m.customerCompany,customerEmail:m.customerEmail,customerAddress:m.customerAddress})}this.loading=!1}).catch(c=>{console.error("Error loading jobs:",c),this.snackBar.open("Error loading job information.","Close",{duration:5e3}),this.loading=!1})}catch(e){console.error("Error querying jobs:",e),this.loading=!1}}calculateTotals(){let e=this.selectedJobs.reduce((t,c)=>t+(c.amount||0),0);this.chargeableExpenses=0,this.selectedJobs.forEach(t=>{if(t.expenses&&t.expenses.length>0){let c=t.expenses.filter(m=>m.approved).reduce((m,l)=>m+l.amount,0);this.chargeableExpenses+=c}}),this.totalAmount=e+this.chargeableExpenses,this.invoiceForm.get("totalAmount")?.setValue(this.totalAmount)}onSubmit(){return I(this,null,function*(){if(this.invoiceForm.invalid){Object.keys(this.invoiceForm.controls).forEach(e=>{this.invoiceForm.get(e)?.markAsTouched()}),this.snackBar.open("Please fill in all required fields.","Close",{duration:3e3});return}this.saving=!0;try{let e=this.invoiceForm.getRawValue(),t={customerName:e.customerName,customerCompany:e.customerCompany,customerEmail:e.customerEmail,customerAddress:e.customerAddress,dueDate:S.fromDate(e.dueDate),totalAmount:this.totalAmount,jobAmount:this.selectedJobs.reduce((f,_)=>f+(_.amount||0),0),expensesAmount:this.chargeableExpenses,notes:e.notes,status:"Draft",createdAt:S.now(),jobIds:this.jobIds,invoiceNumber:yield this.generateInvoiceNumber()},c=P(this.firestore,"Invoices"),m=yield L(c,t),l=this.jobIds.map(f=>{let _=H(this.firestore,"Jobs",f);return K(_,{invoiceId:m.id})});yield Promise.all(l),this.snackBar.open("Invoice saved successfully.","Close",{duration:3e3}),this.router.navigate(["/billing/invoice",m.id])}catch(e){console.error("Error saving invoice:",e),this.snackBar.open("Error saving invoice. Please try again.","Close",{duration:5e3}),this.saving=!1}})}generateInvoiceNumber(){return I(this,null,function*(){let e=P(this.firestore,"Invoices"),t=yield w(e),c=0;return t.docs.forEach(l=>{let f=l.data();if(f.invoiceNumber){let _=f.invoiceNumber.match(/^INV-(\d+)$/);if(_){let d=parseInt(_[1],10);d>c&&(c=d)}}}),`INV-${(c+1).toString().padStart(5,"0")}`})}sendInvoice(){this.onSubmit().then(()=>{this.snackBar.open("Invoice has been emailed to the customer.","Close",{duration:3e3})})}cancelInvoice(){this.router.navigate(["/billing"])}formatCurrency(e){return`\xA3${e.toFixed(2)}`}get jobAmount(){return this.selectedJobs.reduce((e,t)=>e+(t.amount||0),0)}static \u0275fac=function(t){return new(t||o)(x(oe),x($),x(V),x(R),x(Oe))};static \u0275cmp=D({type:o,selectors:[["app-generate-invoice"]],decls:10,vars:2,consts:[["dueDatePicker",""],[1,"invoice-form-container"],[1,"page-header"],[1,"title-section"],["mat-icon-button","","color","primary",1,"back-button",3,"click"],[1,"page-title"],["class","loading-container",4,"ngIf"],["class","form-content",4,"ngIf"],[1,"loading-container"],["diameter","50"],[1,"form-content"],[3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-row"],["appearance","outline"],["matInput","","formControlName","customerName"],[4,"ngIf"],["matInput","","formControlName","customerCompany"],["matInput","","formControlName","customerEmail","type","email"],["matInput","","formControlName","customerAddress","rows","3"],["matInput","","formControlName","dueDate",3,"matDatepicker"],["matSuffix","",3,"for"],["class","form-card",4,"ngIf"],["matInput","","formControlName","notes","rows","3"],[1,"totals-section"],[1,"total-row"],[1,"total-label"],[1,"total-value"],["class","total-row",4,"ngIf"],[1,"total-row","total-amount"],[1,"form-actions"],["type","button","mat-stroked-button","",3,"click"],["type","button","mat-raised-button","","color","accent",3,"click","disabled"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20",4,"ngIf"],[1,"jobs-list"],["class","job-item",4,"ngFor","ngForOf"],["class","expenses-section",4,"ngIf"],[1,"job-item"],[1,"job-header"],[1,"job-id"],[1,"job-amount"],[1,"job-details"],[1,"job-vehicle"],[1,"job-status"],[1,"expenses-section"],[1,"expenses-list"],[4,"ngFor","ngForOf"],["class","expense-item",4,"ngFor","ngForOf"],[1,"expense-item"],[1,"expense-description"],[1,"expense-amount"],["diameter","20"]],template:function(t,c){t&1&&(i(0,"div",1)(1,"div",2)(2,"div",3)(3,"button",4),b("click",function(){return c.cancelInvoice()}),i(4,"mat-icon"),r(5,"arrow_back"),n()(),i(6,"h1",5),r(7,"Generate Invoice"),n()()(),p(8,Ge,2,0,"div",6)(9,Ze,75,16,"div",7),n()),t&2&&(a(8),s("ngIf",c.loading),a(),s("ngIf",!c.loading))},dependencies:[q,J,B,z,ie,ee,X,Y,Z,te,ne,ge,ue,le,de,pe,_e,fe,Ce,xe,ve,Me,be,se,re,ce,me,ae,Pe,he,Ie,Ne,De,we,ye,je,Se,Ee,ke,Fe,O],styles:[".invoice-form-container[_ngcontent-%COMP%]{padding:20px;background-color:#f5f5f5;min-height:100%}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.page-header[_ngcontent-%COMP%]   .title-section[_ngcontent-%COMP%]{display:flex;align-items:center}.page-header[_ngcontent-%COMP%]   .title-section[_ngcontent-%COMP%]   .back-button[_ngcontent-%COMP%]{margin-right:8px;color:#4a3c31}.page-header[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]{font-size:24px;font-weight:500;color:#4a3c31;margin:0}.loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:200px}.form-content[_ngcontent-%COMP%]   .form-card[_ngcontent-%COMP%]{margin-bottom:24px;border-radius:8px;box-shadow:0 2px 10px #0000001a}.form-content[_ngcontent-%COMP%]   .form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]{padding:16px 16px 0}.form-content[_ngcontent-%COMP%]   .form-card[_ngcontent-%COMP%]   .mat-mdc-card-header[_ngcontent-%COMP%]   .mat-mdc-card-title[_ngcontent-%COMP%]{color:#4a3c31;font-size:18px;margin-bottom:8px}.form-content[_ngcontent-%COMP%]   .form-card[_ngcontent-%COMP%]   .mat-mdc-card-content[_ngcontent-%COMP%]{padding:16px}.form-content[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{margin-bottom:16px;width:100%}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px;margin-bottom:16px}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]{padding:12px;border:1px solid #e0e0e0;border-radius:4px;background-color:#fff}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:8px}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   .job-id[_ngcontent-%COMP%]{font-weight:500;color:#4a3c31}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   .job-amount[_ngcontent-%COMP%]{font-weight:500;color:#c19a6b}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-details[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-details[_ngcontent-%COMP%]   .job-vehicle[_ngcontent-%COMP%]{font-size:14px;color:#333}.form-content[_ngcontent-%COMP%]   .jobs-list[_ngcontent-%COMP%]   .job-item[_ngcontent-%COMP%]   .job-details[_ngcontent-%COMP%]   .job-status[_ngcontent-%COMP%]{font-size:12px;color:#9e9e9e}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]{margin-top:16px}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:16px;font-weight:500;color:#4a3c31;margin-bottom:12px}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]   .expenses-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]   .expenses-list[_ngcontent-%COMP%]   .expense-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:8px 12px;background-color:#e0e0e04d;border-radius:4px}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]   .expenses-list[_ngcontent-%COMP%]   .expense-item[_ngcontent-%COMP%]   .expense-description[_ngcontent-%COMP%]{font-size:14px;color:#333}.form-content[_ngcontent-%COMP%]   .expenses-section[_ngcontent-%COMP%]   .expenses-list[_ngcontent-%COMP%]   .expense-item[_ngcontent-%COMP%]   .expense-amount[_ngcontent-%COMP%]{font-weight:500;color:#333}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]{margin-top:24px;border-top:1px solid #e0e0e0;padding-top:16px}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:8px}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row[_ngcontent-%COMP%]   .total-label[_ngcontent-%COMP%]{font-weight:400;color:#333}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row[_ngcontent-%COMP%]   .total-value[_ngcontent-%COMP%]{font-weight:500;color:#333}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row.total-amount[_ngcontent-%COMP%]{margin-top:16px;padding-top:12px;border-top:1px dashed #e0e0e0;font-size:18px}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row.total-amount[_ngcontent-%COMP%]   .total-label[_ngcontent-%COMP%]{font-weight:500;color:#4a3c31}.form-content[_ngcontent-%COMP%]   .totals-section[_ngcontent-%COMP%]   .total-row.total-amount[_ngcontent-%COMP%]   .total-value[_ngcontent-%COMP%]{font-weight:600;color:#c19a6b}.form-content[_ngcontent-%COMP%]   .form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:16px;margin-top:24px;margin-bottom:40px}.form-content[_ngcontent-%COMP%]   .form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{min-width:120px}.form-content[_ngcontent-%COMP%]   .form-actions[_ngcontent-%COMP%]   button[color=primary][_ngcontent-%COMP%]{background-color:#c19a6b;color:#fff}.form-content[_ngcontent-%COMP%]   .form-actions[_ngcontent-%COMP%]   button[color=accent][_ngcontent-%COMP%]{background-color:#4a3c31;color:#fff}.mat-mdc-form-field[_ngcontent-%COMP%]{width:100%}@media (max-width: 768px){.page-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:16px}.form-actions[_ngcontent-%COMP%]{flex-direction:column;width:100%}.form-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}@media (max-width: 480px){.invoice-form-container[_ngcontent-%COMP%]{padding:12px}.job-header[_ngcontent-%COMP%]{flex-direction:column;gap:4px}}"]})};export{Ae as GenerateInvoiceComponent};
