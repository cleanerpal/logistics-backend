<!-- billing.component.html -->
<div class="billing-container">
  <div class="page-header">
    <h1 class="page-title">Billing & Invoicing</h1>
  </div>

  <mat-card class="search-card">
    <mat-card-content>
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input
          matInput
          [formControl]="searchControl"
          placeholder="Search by ID, customer name or vehicle..."
        />
        <button
          *ngIf="searchControl.value"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="searchControl.setValue('')"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </mat-card-content>
  </mat-card>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Content tabs -->
  <div class="billing-content" *ngIf="!loading">
    <mat-tab-group
      (selectedTabChange)="onTabChange($event)"
      animationDuration="200ms"
    >
      <!-- Ready to Invoice Tab -->
      <mat-tab label="Ready to Invoice">
        <div class="tab-actions">
          <button
            mat-raised-button
            color="primary"
            [disabled]="!canGenerateInvoice()"
            (click)="generateInvoice()"
          >
            <mat-icon>receipt</mat-icon>
            Generate Invoice
          </button>
        </div>

        <!-- Jobs Table -->
        <div class="table-container">
          <table
            mat-table
            [dataSource]="jobsDataSource"
            matSort
            #jobsSort="matSort"
            class="billing-table"
          >
            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                  (change)="$event ? toggleAllRows() : null"
                  [checked]="jobsSelection.hasValue() && isAllSelected()"
                  [indeterminate]="jobsSelection.hasValue() && !isAllSelected()"
                  [aria-label]="checkboxLabel()"
                >
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let job">
                <mat-checkbox
                  (click)="$event.stopPropagation()"
                  (change)="$event ? jobsSelection.toggle(job) : null"
                  [checked]="jobsSelection.isSelected(job)"
                  [aria-label]="checkboxLabel(job)"
                >
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- Job ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Job ID</th>
              <td mat-cell *matCellDef="let job">{{ job.id }}</td>
            </ng-container>

            <!-- Vehicle Column -->
            <ng-container matColumnDef="vehicle">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Vehicle</th>
              <td mat-cell *matCellDef="let job">
                {{ job.vehicleMake }} {{ job.vehicleModel }}
                <div class="vehicle-reg">{{ job.vehicleRegistration }}</div>
              </td>
            </ng-container>

            <!-- Customer Column -->
            <ng-container matColumnDef="customer">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Customer
              </th>
              <td mat-cell *matCellDef="let job">
                {{ job.customerName }}
                <div class="company-name" *ngIf="job.customerCompany">
                  {{ job.customerCompany }}
                </div>
              </td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let job">
                <div class="amount-container">
                  <span *ngIf="job.amount"
                    >£{{ job.amount | number : "1.2-2" }}</span
                  >
                  <span *ngIf="!job.amount" class="no-amount">Not set</span>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let job">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editJobAmount(job.id, $event)"
                  matTooltip="Edit Job Amount"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Row definitions -->
            <tr
              mat-header-row
              *matHeaderRowDef="jobsColumns; sticky: true"
            ></tr>
            <tr
              mat-row
              *matRowDef="let job; columns: jobsColumns"
              [class.no-amount-row]="!job.amount"
              (click)="editJobAmount(job.id, $event)"
            ></tr>

            <!-- No data row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="jobsColumns.length">
                No jobs found that are ready for invoicing
              </td>
            </tr>
          </table>

          <!-- Paginator -->
          <mat-paginator
            #jobsPaginator
            [pageSizeOptions]="[10, 25, 50]"
            pageSize="10"
            showFirstLastButtons
          >
          </mat-paginator>
        </div>
      </mat-tab>

      <!-- Invoices List Tab -->
      <mat-tab label="Invoices List">
        <div class="tab-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="createManualInvoice()"
          >
            <mat-icon>add</mat-icon>
            Create Invoice
          </button>
        </div>

        <!-- Invoices Table -->
        <div class="table-container">
          <table
            mat-table
            [dataSource]="invoicesDataSource"
            matSort
            #invoicesSort="matSort"
            class="billing-table"
          >
            <!-- Invoice ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Invoice #
              </th>
              <td mat-cell *matCellDef="let invoice">{{ invoice.id }}</td>
            </ng-container>

            <!-- Customer Column -->
            <ng-container matColumnDef="customer">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Customer
              </th>
              <td mat-cell *matCellDef="let invoice">
                {{ invoice.customerName }}
                <div class="company-name" *ngIf="invoice.customerCompany">
                  {{ invoice.customerCompany }}
                </div>
              </td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let invoice">
                £{{ invoice.totalAmount | number : "1.2-2" }}
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let invoice">
                <span
                  class="status-badge"
                  [ngClass]="getStatusClass(invoice.status)"
                >
                  {{ invoice.status }}
                </span>
              </td>
            </ng-container>

            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let invoice">
                {{ formatDate(invoice.createdAt) }}
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let invoice">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="viewInvoice(invoice.id); $event.stopPropagation()"
                  matTooltip="View Invoice"
                >
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Row definitions -->
            <tr
              mat-header-row
              *matHeaderRowDef="invoicesColumns; sticky: true"
            ></tr>
            <tr
              mat-row
              *matRowDef="let invoice; columns: invoicesColumns"
              (click)="viewInvoice(invoice.id)"
            ></tr>

            <!-- No data row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="invoicesColumns.length">
                No invoices found
              </td>
            </tr>
          </table>

          <!-- Paginator -->
          <mat-paginator
            #invoicesPaginator
            [pageSizeOptions]="[10, 25, 50]"
            pageSize="10"
            showFirstLastButtons
          >
          </mat-paginator>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
