<!-- generate-invoice.component.html -->
<div class="invoice-form-container">
  <div class="page-header">
    <div class="title-section">
      <button
        mat-icon-button
        color="primary"
        (click)="cancelInvoice()"
        class="back-button"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1 class="page-title">Generate Invoice</h1>
    </div>
  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Invoice form -->
  <div class="form-content" *ngIf="!loading">
    <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
      <!-- Customer information -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Customer Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Customer Name</mat-label>
              <input matInput formControlName="customerName" />
              <mat-error
                *ngIf="invoiceForm.get('customerName')?.hasError('required')"
              >
                Customer name is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Company Name</mat-label>
              <input matInput formControlName="customerCompany" />
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput formControlName="customerEmail" type="email" />
              <mat-error
                *ngIf="invoiceForm.get('customerEmail')?.hasError('required')"
              >
                Email is required
              </mat-error>
              <mat-error
                *ngIf="invoiceForm.get('customerEmail')?.hasError('email')"
              >
                Please enter a valid email address
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Address</mat-label>
              <textarea
                matInput
                formControlName="customerAddress"
                rows="3"
              ></textarea>
              <mat-error
                *ngIf="invoiceForm.get('customerAddress')?.hasError('required')"
              >
                Address is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Due Date</mat-label>
              <input
                matInput
                [matDatepicker]="dueDatePicker"
                formControlName="dueDate"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="dueDatePicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #dueDatePicker></mat-datepicker>
              <mat-error
                *ngIf="invoiceForm.get('dueDate')?.hasError('required')"
              >
                Due date is required
              </mat-error>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Job items -->
      <mat-card class="form-card" *ngIf="selectedJobs.length > 0">
        <mat-card-header>
          <mat-card-title>Job Details</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="jobs-list">
            <div class="job-item" *ngFor="let job of selectedJobs">
              <div class="job-header">
                <div class="job-id">{{ job.id }}</div>
                <div class="job-amount">
                  {{ formatCurrency(job.amount || 0) }}
                </div>
              </div>
              <div class="job-details">
                <div class="job-vehicle">
                  {{ job.vehicleMake }} {{ job.vehicleModel }} ({{
                    job.vehicleRegistration
                  }})
                </div>
                <div class="job-status">Status: {{ job.status }}</div>
              </div>
            </div>
          </div>

          <mat-divider *ngIf="chargeableExpenses > 0"></mat-divider>

          <!-- Chargeable expenses section -->
          <div class="expenses-section" *ngIf="chargeableExpenses > 0">
            <h3>Chargeable Expenses</h3>
            <div class="expenses-list">
              <ng-container *ngFor="let job of selectedJobs">
                <ng-container *ngIf="job.expenses && job.expenses.length > 0">
                  <div
                    class="expense-item"
                    *ngFor="let expense of job.expenses | approvedExpenses"
                  >
                    <div class="expense-description">
                      {{ expense.description }}
                    </div>
                    <div class="expense-amount">
                      {{ formatCurrency(expense.amount) }}
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Notes and total -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Invoice Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Notes</mat-label>
              <textarea matInput formControlName="notes" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="totals-section">
            <div class="total-row">
              <div class="total-label">Job Amount:</div>
              <div class="total-value">
                {{ formatCurrency(jobAmount) }}
              </div>
            </div>
            <div class="total-row" *ngIf="chargeableExpenses > 0">
              <div class="total-label">Expenses:</div>
              <div class="total-value">
                {{ formatCurrency(chargeableExpenses) }}
              </div>
            </div>
            <div class="total-row total-amount">
              <div class="total-label">Total Amount:</div>
              <div class="total-value">{{ formatCurrency(totalAmount) }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Form actions -->
      <div class="form-actions">
        <button type="button" mat-stroked-button (click)="cancelInvoice()">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>

        <button
          type="button"
          mat-raised-button
          color="accent"
          (click)="sendInvoice()"
          [disabled]="saving || invoiceForm.invalid"
        >
          <mat-icon>email</mat-icon>
          Save & Send
        </button>

        <button
          type="submit"
          mat-raised-button
          color="primary"
          [disabled]="saving"
        >
          <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
          <span *ngIf="!saving">
            <mat-icon>save</mat-icon>
            Save as Draft
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
