<!-- driver-details.component.html -->
<mat-card class="mat-elevation-z3">
  <!-- Loading Spinner -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading driver details...</span>
  </div>

  <!-- Header -->
  <div class="header-wrapper">
    <div class="header-title">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-content" *ngIf="driver">
        <h1>{{ driver.firstName }} {{ driver.lastName }}</h1>
        <div class="driver-status">
          <span class="status-chip" [ngClass]="getStatusClass(driver.status)">
            {{ driver.status }}
          </span>
          <span class="role-chip" [ngClass]="getRoleClass(driver.role)">
            {{ driver.role }}
          </span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-stroked-button color="warn" (click)="deleteDriver()" *ngIf="hasEditPermission">
        <mat-icon>delete</mat-icon>
        Delete Driver
      </button>
      <button mat-flat-button color="primary" (click)="editDriver()" *ngIf="hasEditPermission">
        <mat-icon>edit</mat-icon>
        Edit Driver
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button [class.active]="activeTab === 'details'" (click)="setActiveTab('details')">Details</button>
    <button [class.active]="activeTab === 'jobs'" (click)="setActiveTab('jobs')">Jobs</button>
    <button [class.active]="activeTab === 'permissions'" (click)="setActiveTab('permissions')">Permissions</button>
    <button [class.active]="activeTab === 'notes'" (click)="setActiveTab('notes')">Notes</button>
  </div>

  <!-- Driver Details -->
  <mat-card-content class="content-wrapper" *ngIf="driver">
    <div [ngSwitch]="activeTab">
      <!-- Details Tab -->
      <div *ngSwitchCase="'details'" class="details-tab">
        <div class="details-grid">
          <!-- Driver Information -->
          <mat-card class="details-section">
            <h2>Driver Information</h2>
            <div class="info-grid">
              <div class="info-item">
                <label>Driver ID</label>
                <span>{{ driver.id }}</span>
              </div>
              <div class="info-item">
                <label>Email</label>
                <a [href]="'mailto:' + driver.email">{{ driver.email }}</a>
              </div>
              <div class="info-item">
                <label>Phone</label>
                <a [href]="'tel:' + driver.phone">{{ driver.phone }}</a>
              </div>
              <div class="info-item">
                <label>Company</label>
                <span>{{ driver.company || 'Not assigned' }}</span>
              </div>
              <div class="info-item">
                <label>Type</label>
                <span class="status-chip small" [ngClass]="getTypeClass(driver.type)">
                  {{ driver.type }}
                </span>
              </div>
              <div class="info-item">
                <label>Role</label>
                <span class="role-chip small" [ngClass]="getRoleClass(driver.role)">
                  {{ driver.role }}
                </span>
              </div>
              <div class="info-item">
                <label>Status</label>
                <span class="status-chip small" [ngClass]="getStatusClass(driver.status)">
                  {{ driver.status }}
                </span>
              </div>
              <div class="info-item">
                <label>Last Activity</label>
                <span>{{ driver.lastActivity | date }}</span>
              </div>
            </div>
          </mat-card>

          <!-- Statistics Card -->
          <mat-card class="details-section stats-section">
            <h2>Activity Overview</h2>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-icon">
                  <mat-icon>directions_car</mat-icon>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ driverStats.totalJobs }}</span>
                  <span class="stat-label">Total Jobs</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <mat-icon>pending_actions</mat-icon>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ driverStats.pendingJobs }}</span>
                  <span class="stat-label">Pending Jobs</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <mat-icon>check_circle</mat-icon>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ driverStats.completedJobs }}</span>
                  <span class="stat-label">Completed Jobs</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <mat-icon>payments</mat-icon>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ driverStats.pendingExpenses }}</span>
                  <span class="stat-label">Pending Expenses</span>
                </div>
              </div>
            </div>
          </mat-card>
        </div>

        <!-- Additional Information -->
        <mat-card class="profile-section">
          <h2>Driver Profile</h2>
          <div class="profile-content">
            <div class="profile-header">
              <div class="profile-avatar">
                {{ getDriverInitials(driver) }}
              </div>
              <div class="profile-details">
                <h3>{{ driver.firstName }} {{ driver.lastName }}</h3>
                <p class="profile-company">{{ driver.company || 'Independent Driver' }}</p>
                <div class="contact-buttons">
                  <a mat-stroked-button [href]="'mailto:' + driver.email" class="contact-button">
                    <mat-icon>email</mat-icon>
                    Email
                  </a>
                  <a mat-stroked-button [href]="'tel:' + driver.phone" class="contact-button">
                    <mat-icon>phone</mat-icon>
                    Call
                  </a>
                  <button mat-stroked-button class="contact-button" (click)="sendMessage()">
                    <mat-icon>message</mat-icon>
                    Message
                  </button>
                </div>
              </div>
            </div>
            <div class="profile-section-divider"></div>
            <div class="profile-info">
              <div class="info-row">
                <span class="info-label">License Number</span>
                <span class="info-value">{{ driver.licenseNumber || 'Not provided' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">License Expiry</span>
                <span class="info-value">{{ driver.licenseExpiry | date }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Vehicle Type</span>
                <span class="info-value">{{ driver.vehicleType || 'Not specified' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Area Coverage</span>
                <span class="info-value">{{ driver.areaCoverage || 'No restrictions' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Availability</span>
                <span class="info-value">{{ driver.availability || 'Full-time' }}</span>
              </div>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Jobs Tab -->
      <div *ngSwitchCase="'jobs'" class="jobs-tab">
        <mat-card class="jobs-section">
          <div class="section-header">
            <h2>Job History</h2>
            <button mat-stroked-button color="primary" [routerLink]="['/jobs/new']" [queryParams]="{ driverId: driver.id }">
              <mat-icon>add</mat-icon>
              Assign New Job
            </button>
          </div>

          <!-- Loading Jobs Spinner -->
          <div class="loading-overlay" *ngIf="isJobsLoading">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading jobs...</span>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="jobsDataSource" class="jobs-table" matSort>
              <!-- Job ID Column -->
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Job ID</th>
                <td mat-cell *matCellDef="let job">{{ job.id }}</td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                <td mat-cell *matCellDef="let job">
                  <span class="status-chip small" [ngClass]="getJobStatusClass(job.status)">
                    {{ job.status }}
                  </span>
                </td>
              </ng-container>

              <!-- Vehicle Column -->
              <ng-container matColumnDef="vehicle">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Vehicle</th>
                <td mat-cell *matCellDef="let job">
                  {{ job.registration || 'N/A' }}
                </td>
              </ng-container>

              <!-- Collection Column -->
              <ng-container matColumnDef="collection">
                <th mat-header-cell *matHeaderCellDef>Collection</th>
                <td mat-cell *matCellDef="let job">
                  {{ job.collectionAddress ? (job.collectionAddress | slice : 0 : 30) + (job.collectionAddress.length > 30 ? '...' : '') : 'N/A' }}
                </td>
              </ng-container>

              <!-- Delivery Column -->
              <ng-container matColumnDef="delivery">
                <th mat-header-cell *matHeaderCellDef>Delivery</th>
                <td mat-cell *matCellDef="let job">
                  {{ job.deliveryAddress ? (job.deliveryAddress | slice : 0 : 30) + (job.deliveryAddress.length > 30 ? '...' : '') : 'N/A' }}
                </td>
              </ng-container>

              <!-- Date Column -->
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                <td mat-cell *matCellDef="let job">{{ job.createdAt | date }}</td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let job">
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="viewJobDetails(job.id)">
                      <mat-icon>visibility</mat-icon>
                      <span>View Details</span>
                    </button>
                    <button mat-menu-item (click)="editJob(job.id)" *ngIf="hasEditPermission">
                      <mat-icon>edit</mat-icon>
                      <span>Edit Job</span>
                    </button>
                    <button mat-menu-item (click)="unassignJob(job)" *ngIf="hasEditPermission && canUnassignJob(job)">
                      <mat-icon>person_remove</mat-icon>
                      <span>Unassign Job</span>
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="jobColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: jobColumns" (click)="viewJobDetails(row.id)" class="job-row"></tr>
            </table>

            <!-- Empty state for jobs -->
            <div class="empty-state" *ngIf="!isJobsLoading && jobsDataSource.data.length === 0">
              <mat-icon>work_off</mat-icon>
              <h3>No Jobs Found</h3>
              <p>This driver doesn't have any jobs yet.</p>
              <button mat-flat-button color="primary" [routerLink]="['/jobs/new']" [queryParams]="{ driverId: driver.id }">
                <mat-icon>add</mat-icon>
                Assign First Job
              </button>
            </div>
          </div>

          <!-- Jobs Paginator -->
          <mat-paginator [pageSizeOptions]="[5, 10, 25]" [length]="jobsDataSource.data.length" showFirstLastButtons> </mat-paginator>
        </mat-card>
      </div>

      <!-- Permissions Tab -->
      <div *ngSwitchCase="'permissions'" class="permissions-tab">
        <mat-card class="permissions-section">
          <div class="section-header">
            <h2>Permissions & Access</h2>
            <button mat-flat-button color="primary" (click)="editPermissions()" *ngIf="hasEditPermission">
              <mat-icon>edit</mat-icon>
              Edit Permissions
            </button>
          </div>

          <div class="permissions-content">
            <div class="role-summary">
              <h3>Role: {{ driver.role }}</h3>
              <p class="role-description">
                {{ getRoleDescription(driver.role) }}
              </p>
            </div>

            <div class="permissions-grid">
              <div class="permission-item" *ngFor="let perm of permissionList">
                <div class="permission-header">
                  <mat-icon>{{ getPermissionIcon(perm.key) }}</mat-icon>
                  <span class="permission-name">{{ perm.name }}</span>
                </div>
                <div class="permission-status" [ngClass]="{ 'permission-granted': hasPermission(perm.key), 'permission-denied': !hasPermission(perm.key) }">
                  <mat-icon>{{ hasPermission(perm.key) ? 'check_circle' : 'cancel' }}</mat-icon>
                  <span>{{ hasPermission(perm.key) ? 'Granted' : 'Not Granted' }}</span>
                </div>
                <p class="permission-description">{{ perm.description }}</p>
              </div>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Notes Tab -->
      <div *ngSwitchCase="'notes'" class="notes-tab">
        <mat-card class="notes-section">
          <div class="section-header">
            <h2>Driver Notes</h2>
            <button mat-flat-button color="primary" (click)="addNote()" *ngIf="hasEditPermission">
              <mat-icon>add</mat-icon>
              Add Note
            </button>
          </div>

          <div class="notes-timeline" *ngIf="driverNotes.length > 0">
            <div class="note-item" *ngFor="let note of driverNotes">
              <div class="note-header">
                <div class="note-author">
                  <span class="author-avatar">{{ getInitials(note.authorName) }}</span>
                  <div class="author-details">
                    <span class="author-name">{{ note.authorName }}</span>
                    <span class="note-date">{{ note.date | date : 'medium' }}</span>
                  </div>
                </div>
                <button mat-icon-button [matMenuTriggerFor]="noteMenu" *ngIf="hasEditPermission">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #noteMenu="matMenu">
                  <button mat-menu-item (click)="editNote(note)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit</span>
                  </button>
                  <button mat-menu-item (click)="deleteNote(note)">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </div>
              <div class="note-content">
                <p>{{ note.content }}</p>
              </div>
            </div>
          </div>

          <div class="empty-notes" *ngIf="driverNotes.length === 0">
            <mat-icon>note</mat-icon>
            <h3>No Notes</h3>
            <p>There are no notes for this driver yet.</p>
            <button mat-flat-button color="primary" (click)="addNote()" *ngIf="hasEditPermission">
              <mat-icon>add</mat-icon>
              Add First Note
            </button>
          </div>
        </mat-card>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<!-- Permissions Dialog Template -->
<ng-template #permissionsDialog>
  <h2 mat-dialog-title>Edit Permissions for {{ driver?.firstName }} {{ driver?.lastName }}</h2>
  <mat-dialog-content>
    <form [formGroup]="permissionsForm">
      <!-- Role Selection -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Role</mat-label>
        <mat-select formControlName="role" (selectionChange)="onRoleChange($event)">
          <mat-option *ngFor="let role of availableRoles" [value]="role">{{ role }}</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="permissions-checkboxes">
        <h3>Custom Permissions</h3>
        <p class="permissions-hint">Customize individual permissions for this driver</p>

        <div class="checkbox-grid">
          <mat-checkbox formControlName="canAllocateJobs" color="primary"> Allocate Jobs </mat-checkbox>
          <mat-checkbox formControlName="canApproveExpenses" color="primary"> Approve Expenses </mat-checkbox>
          <mat-checkbox formControlName="canCreateJobs" color="primary"> Create Jobs </mat-checkbox>
          <mat-checkbox formControlName="canEditJobs" color="primary"> Edit Jobs </mat-checkbox>
          <mat-checkbox formControlName="canManageUsers" color="primary"> Manage Users </mat-checkbox>
          <mat-checkbox formControlName="canViewReports" color="primary"> View Reports </mat-checkbox>
          <mat-checkbox formControlName="canViewUnallocated" color="primary"> View Unallocated Jobs </mat-checkbox>
          <mat-checkbox formControlName="isAdmin" color="primary"> Administrator </mat-checkbox>
        </div>
      </div>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-flat-button color="primary" (click)="savePermissions()">Save Permissions</button>
  </mat-dialog-actions>
</ng-template>

<!-- Note Dialog Template -->
<ng-template #noteDialog>
  <h2 mat-dialog-title>{{ editingNote ? 'Edit Note' : 'Add Note' }}</h2>
  <mat-dialog-content>
    <form [formGroup]="noteForm">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Note</mat-label>
        <textarea matInput formControlName="content" rows="6" placeholder="Enter note about this driver"></textarea>
        <mat-error *ngIf="noteForm.get('content')?.hasError('required')">Note content is required</mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-flat-button color="primary" (click)="saveNote()" [disabled]="noteForm.invalid">Save Note</button>
  </mat-dialog-actions>
</ng-template>
