<div class="reports-container">
  <div class="page-header">
    <h1 class="page-title">Reports</h1>
  </div>

  <!-- Report Controls -->
  <mat-card class="controls-card">
    <mat-card-content>
      <form [formGroup]="reportForm" class="report-controls">
        <div class="control-row">
          <!-- Report Type Selector -->
          <mat-form-field appearance="outline" class="report-type-field">
            <mat-label>Report Type</mat-label>
            <mat-select formControlName="reportType">
              <mat-option *ngFor="let type of reportTypes" [value]="type.value">
                {{ type.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Date Period Selector -->
          <mat-form-field appearance="outline" class="period-field">
            <mat-label>Period</mat-label>
            <mat-select formControlName="period">
              <mat-option *ngFor="let period of periods" [value]="period.value">
                {{ period.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Custom Date Range -->
        <div
          class="date-range-container"
          *ngIf="reportForm.get('period')?.value === 'custom'"
        >
          <div formGroupName="dateRange" class="date-range-fields">
            <mat-form-field appearance="outline">
              <mat-label>Start Date</mat-label>
              <input
                matInput
                [matDatepicker]="startPicker"
                formControlName="start"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="startPicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>End Date</mat-label>
              <input
                matInput
                [matDatepicker]="endPicker"
                formControlName="end"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="endPicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button
            mat-raised-button
            color="primary"
            class="generate-button"
            (click)="generateReport()"
          >
            <mat-icon>refresh</mat-icon>
            Generate Report
          </button>

          <button
            mat-stroked-button
            class="export-button"
            (click)="exportCsv()"
          >
            <mat-icon>file_download</mat-icon>
            Export CSV
          </button>

          <button
            mat-stroked-button
            class="export-button"
            (click)="exportPdf()"
          >
            <mat-icon>picture_as_pdf</mat-icon>
            Export PDF
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Report Content -->
  <div class="report-content" *ngIf="!loading">
    <mat-card class="report-card">
      <mat-card-header>
        <mat-card-title>{{ reportTitle }}</mat-card-title>
        <mat-card-subtitle>
          {{ reportForm.get("dateRange.start")?.value | date : "MMM d, y" }} -
          {{ reportForm.get("dateRange.end")?.value | date : "MMM d, y" }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- Driver Performance Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'driver-performance'"
          class="report-table-container"
        >
          <table
            mat-table
            [dataSource]="driverPerformanceDataSource"
            matSort
            #driverPerformanceSort="matSort"
            class="report-table"
          >
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Driver</th>
              <td mat-cell *matCellDef="let driver">{{ driver.name }}</td>
            </ng-container>

            <!-- Jobs Completed Column -->
            <ng-container matColumnDef="jobsCompleted">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Jobs Completed
              </th>
              <td mat-cell *matCellDef="let driver">
                {{ driver.jobsCompleted }}
              </td>
            </ng-container>

            <!-- On-Time Rate Column -->
            <ng-container matColumnDef="onTimeRate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                On-Time Rate
              </th>
              <td mat-cell *matCellDef="let driver">
                <div class="progress-container">
                  <div
                    class="progress-bar"
                    [style.width.%]="driver.onTimeRate"
                    [ngClass]="{
                      excellent: driver.onTimeRate >= 90,
                      good: driver.onTimeRate >= 80 && driver.onTimeRate < 90,
                      average:
                        driver.onTimeRate >= 70 && driver.onTimeRate < 80,
                      poor: driver.onTimeRate < 70
                    }"
                  >
                    {{ driver.onTimeRate }}%
                  </div>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="driverPerformanceColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: driverPerformanceColumns"
            ></tr>
          </table>

          <mat-paginator
            #driverPerformancePaginator="matPaginator"
            [pageSizeOptions]="[5, 10, 25]"
            showFirstLastButtons
            aria-label="Select page of driver performance"
          >
          </mat-paginator>
        </div>

        <!-- Vehicle Utilization Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'vehicle-utilization'"
          class="report-table-container"
        >
          <table
            mat-table
            [dataSource]="vehicleUtilizationDataSource"
            matSort
            #vehicleUtilizationSort="matSort"
            class="report-table"
          >
            <!-- Registration Column -->
            <ng-container matColumnDef="registration">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Registration
              </th>
              <td mat-cell *matCellDef="let vehicle">
                {{ vehicle.registration }}
              </td>
            </ng-container>

            <!-- Make/Model Column -->
            <ng-container matColumnDef="makeModel">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Make/Model
              </th>
              <td mat-cell *matCellDef="let vehicle">
                {{ vehicle.makeModel }}
              </td>
            </ng-container>

            <!-- Jobs Completed Column -->
            <ng-container matColumnDef="jobsCompleted">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Jobs Completed
              </th>
              <td mat-cell *matCellDef="let vehicle">
                {{ vehicle.jobsCompleted }}
              </td>
            </ng-container>

            <!-- Mileage Column -->
            <ng-container matColumnDef="mileage">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Mileage</th>
              <td mat-cell *matCellDef="let vehicle">{{ vehicle.mileage }}</td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="vehicleUtilizationColumns"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: vehicleUtilizationColumns"
            ></tr>
          </table>

          <mat-paginator
            #vehicleUtilizationPaginator="matPaginator"
            [pageSizeOptions]="[5, 10, 25]"
            showFirstLastButtons
            aria-label="Select page of vehicle utilization"
          >
          </mat-paginator>
        </div>

        <!-- Revenue by Customer Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'revenue-by-customer'"
          class="report-table-container"
        >
          <table
            mat-table
            [dataSource]="revenueByCustomerDataSource"
            matSort
            #revenueByCustomerSort="matSort"
            class="report-table"
          >
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Customer Name
              </th>
              <td mat-cell *matCellDef="let customer">{{ customer.name }}</td>
            </ng-container>

            <!-- Amount Invoiced Column -->
            <ng-container matColumnDef="amountInvoiced">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Amount Invoiced
              </th>
              <td mat-cell *matCellDef="let customer" class="amount-column">
                Â£{{ customer.amountInvoiced.toFixed(2) }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="revenueByCustomerColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: revenueByCustomerColumns"
            ></tr>
          </table>

          <mat-paginator
            #revenueByCustomerPaginator="matPaginator"
            [pageSizeOptions]="[5, 10, 25]"
            showFirstLastButtons
            aria-label="Select page of revenue by customer"
          >
          </mat-paginator>
        </div>

        <!-- Job Status Summary Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'job-status-summary'"
          class="job-status-container"
        >
          <!-- Chart -->
          <div class="chart-container">
            <canvas id="jobStatusChart"></canvas>
          </div>

          <!-- Table -->
          <div class="report-table-container">
            <table
              mat-table
              [dataSource]="jobStatusSummaryDataSource"
              matSort
              #jobStatusSummarySort="matSort"
              class="report-table"
            >
              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Status
                </th>
                <td mat-cell *matCellDef="let status">
                  <div
                    class="status-indicator"
                    [style.background-color]="status.color"
                  ></div>
                  {{ status.status }}
                </td>
              </ng-container>

              <!-- Count Column -->
              <ng-container matColumnDef="count">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Count</th>
                <td mat-cell *matCellDef="let status">{{ status.count }}</td>
              </ng-container>

              <!-- Percentage Column -->
              <ng-container matColumnDef="percentage">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Percentage
                </th>
                <td mat-cell *matCellDef="let status">
                  {{ status.percentage }}%
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="jobStatusSummaryColumns"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: jobStatusSummaryColumns"
              ></tr>
            </table>

            <mat-paginator
              #jobStatusSummaryPaginator="matPaginator"
              [pageSizeOptions]="[5, 10, 25]"
              showFirstLastButtons
              aria-label="Select page of job status summary"
            >
            </mat-paginator>
          </div>
        </div>

        <!-- Driver Handover Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'driver-handover'"
          class="report-table-container"
        >
          <table
            mat-table
            [dataSource]="driverHandoverDataSource"
            matSort
            #driverHandoverSort="matSort"
            class="report-table"
          >
            <!-- Job ID Column -->
            <ng-container matColumnDef="jobId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Job ID</th>
              <td mat-cell *matCellDef="let handover">{{ handover.jobId }}</td>
            </ng-container>

            <!-- Vehicle ID Column -->
            <ng-container matColumnDef="vehicleId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Vehicle</th>
              <td mat-cell *matCellDef="let handover">
                {{ handover.vehicleId }}
              </td>
            </ng-container>

            <!-- From Driver Column -->
            <ng-container matColumnDef="fromDriver">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                From Driver
              </th>
              <td mat-cell *matCellDef="let handover">
                {{ handover.fromDriver }}
              </td>
            </ng-container>

            <!-- To Driver Column -->
            <ng-container matColumnDef="toDriver">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                To Driver
              </th>
              <td mat-cell *matCellDef="let handover">
                {{ handover.toDriver }}
              </td>
            </ng-container>

            <!-- Timestamp Column -->
            <ng-container matColumnDef="timestamp">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Timestamp
              </th>
              <td mat-cell *matCellDef="let handover">
                {{ formatDate(handover.timestamp) }}
              </td>
            </ng-container>

            <!-- Location Column -->
            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Location
              </th>
              <td mat-cell *matCellDef="let handover">
                {{ handover.location }}
              </td>
            </ng-container>

            <!-- Odometer Column -->
            <ng-container matColumnDef="odometer">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Odometer
              </th>
              <td mat-cell *matCellDef="let handover">
                {{ handover.odometer | number }}
              </td>
            </ng-container>

            <!-- Notes Column -->
            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td mat-cell *matCellDef="let handover" class="notes-cell">
                {{ handover.notes }}
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="driverHandoverColumns; sticky: true"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: driverHandoverColumns"
            ></tr>
          </table>

          <mat-paginator
            #driverHandoverPaginator="matPaginator"
            [pageSizeOptions]="[5, 10, 25]"
            showFirstLastButtons
            aria-label="Select page of driver handovers"
          >
          </mat-paginator>
        </div>

        <!-- Driver Hours Report -->
        <div
          *ngIf="reportForm.get('reportType')?.value === 'driver-hours'"
          class="report-table-container"
        >
          <table
            mat-table
            [dataSource]="driverHoursDataSource"
            matSort
            #driverHoursSort="matSort"
            class="report-table"
          >
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Driver Name
              </th>
              <td mat-cell *matCellDef="let hours">{{ hours.name }}</td>
            </ng-container>

            <!-- Total Hours Column -->
            <ng-container matColumnDef="totalHours">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Total Hours
              </th>
              <td mat-cell *matCellDef="let hours">
                {{ hours.totalHours | number : "1.1-1" }}
              </td>
            </ng-container>

            <!-- Period Column -->
            <ng-container matColumnDef="period">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Period</th>
              <td mat-cell *matCellDef="let hours">{{ hours.period }}</td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let hours">
                <span
                  class="status-badge"
                  [ngClass]="getStatusClass(hours.status)"
                >
                  {{ hours.status }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="driverHoursColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: driverHoursColumns"></tr>
          </table>

          <mat-paginator
            #driverHoursPaginator="matPaginator"
            [pageSizeOptions]="[5, 10, 25]"
            showFirstLastButtons
            aria-label="Select page of driver hours"
          >
          </mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
