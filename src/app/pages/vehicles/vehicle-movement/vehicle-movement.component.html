<div class="container">
  <h2 class="page-title">Vehicle Movement Management</h2>

  <mat-card>
    <mat-card-header>
      <mat-card-title>TMS API Integration</mat-card-title>
      <mat-card-subtitle>Record vehicle movements</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="!isAuthenticated" class="auth-container">
        <button
          mat-raised-button
          color="primary"
          (click)="authenticate()"
          [disabled]="isLoading"
        >
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
          <span *ngIf="!isLoading">Authenticate with TMS API</span>
        </button>
      </div>

      <div *ngIf="isAuthenticated">
        <form [formGroup]="movementForm" (ngSubmit)="onSubmit()">
          <div class="form-container">
            <mat-form-field appearance="outline">
              <mat-label>Movement Type</mat-label>
              <mat-select
                formControlName="movementType"
                (selectionChange)="onMovementTypeChange($event)"
              >
                <mat-option
                  *ngFor="let type of movementTypes"
                  [value]="type.value"
                >
                  {{ type.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Registration Number (uppercase, no spaces)</mat-label>
              <input
                matInput
                formControlName="regno"
                autocapitalize="characters"
              />
              <mat-error
                *ngIf="movementForm.get('regno')?.errors?.['required']"
              >
                Registration number is required
              </mat-error>
              <mat-error *ngIf="movementForm.get('regno')?.errors?.['pattern']">
                Registration should be uppercase letters and numbers only, no
                spaces
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>
                {{
                  movementType === "collect" || movementType === "depart"
                    ? "Collection Date"
                    : "Delivery Date"
                }}
              </mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date" />
              <mat-datepicker-toggle
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="movementForm.get('date')?.errors?.['required']">
                Date is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Mileage</mat-label>
              <input matInput type="number" formControlName="mileage" />
              <mat-error
                *ngIf="movementForm.get('mileage')?.errors?.['required']"
              >
                Mileage is required
              </mat-error>
              <mat-error
                *ngIf="movementForm.get('mileage')?.errors?.['pattern']"
              >
                Mileage must be a number
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fuel Level</mat-label>
              <mat-select formControlName="fuelorevlevel">
                <mat-option
                  *ngFor="let level of fuelLevels"
                  [value]="level.value"
                >
                  {{ level.label }}
                </mat-option>
              </mat-select>
              <mat-error
                *ngIf="movementForm.get('fuelorevlevel')?.errors?.['required']"
              >
                Fuel level is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Comments</mat-label>
              <textarea matInput formControlName="comment" rows="3"></textarea>
              <mat-error
                *ngIf="movementForm.get('comment')?.errors?.['required']"
              >
                Comment is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="movementForm.invalid || isLoading"
              class="submit-button"
            >
              <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
              <span *ngIf="!isLoading">
                {{
                  movementType === "collect" || movementType === "depart"
                    ? "Record Collection"
                    : "Record Delivery"
                }}
              </span>
            </button>
          </div>
        </form>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>About TMS API Integration</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>
        This integration allows you to push vehicle movement data directly to
        Enterprise Mobility's Transport Management System (TMS) using their API.
      </p>
      <ul>
        <li>
          <strong>Collect</strong>: Record when a vehicle is collected from a
          location
        </li>
        <li>
          <strong>Deliver</strong>: Record when a vehicle is delivered to a
          location
        </li>
        <li>
          <strong>Arrive</strong>: Record when a vehicle arrives at the compound
        </li>
        <li>
          <strong>Depart</strong>: Record when a vehicle leaves the compound
        </li>
      </ul>
      <p>For technical queries, contact: Richard.baker&#64;reemaq.com</p>
    </mat-card-content>
  </mat-card>
</div>
