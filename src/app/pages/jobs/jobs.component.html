<div class="jobs-container">
  <div class="page-header">
    <h1 class="page-title">Jobs Management</h1>

    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        class="create-button"
        routerLink="/jobs/create"
      >
        <mat-icon>add</mat-icon>
        Create Job
      </button>

      <button
        mat-raised-button
        color="accent"
        class="bulk-button"
        (click)="openBulkUploadDialog()"
      >
        <mat-icon>cloud_upload</mat-icon>
        Bulk Upload
      </button>

      <button
        mat-raised-button
        [color]="isMultiSelectActive ? 'warn' : 'accent'"
        class="multi-button"
        (click)="toggleMultiSelect()"
      >
        <mat-icon>{{
          isMultiSelectActive ? "close" : "playlist_add_check"
        }}</mat-icon>
        {{ isMultiSelectActive ? "Cancel" : "Multi Job Update" }}
      </button>
    </div>
  </div>

  <!-- Search and filter section -->
  <mat-card class="filter-card">
    <mat-card-content>
      <form [formGroup]="searchForm" class="filter-form">
        <div class="search-container">
          <mat-form-field appearance="outline">
            <mat-label>Search</mat-label>
            <input
              matInput
              formControlName="searchText"
              placeholder="Search by ID, registration, status..."
            />
            <button
              *ngIf="searchForm.get('searchText')?.value"
              matSuffix
              mat-icon-button
              aria-label="Clear"
              (click)="searchForm.get('searchText')?.setValue('')"
            >
              <mat-icon>close</mat-icon>
            </button>
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <button
            mat-stroked-button
            color="primary"
            class="reset-button"
            (click)="resetFilters()"
            [disabled]="
              !searchForm.get('searchText')?.value &&
              !searchForm.get('dateRange.start')?.value &&
              !searchForm.get('dateRange.end')?.value
            "
          >
            <mat-icon>refresh</mat-icon>
            Reset
          </button>
        </div>

        <div class="date-container" formGroupName="dateRange">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Date Range</mat-label>
            <mat-date-range-input [rangePicker]="rangePicker">
              <input
                matStartDate
                formControlName="start"
                placeholder="Start date"
              />
              <input matEndDate formControlName="end" placeholder="End date" />
            </mat-date-range-input>
            <mat-datepicker-toggle
              matIconSuffix
              [for]="rangePicker"
            ></mat-datepicker-toggle>
            <mat-date-range-picker #rangePicker></mat-date-range-picker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-type-field">
            <mat-label>Filter By</mat-label>
            <mat-select formControlName="dateType">
              <mat-option value="collection">Collection Date</mat-option>
              <mat-option value="delivery">Delivery Date</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Multi-select update form -->
  <mat-card class="update-card" *ngIf="isMultiSelectActive">
    <mat-card-content>
      <form [formGroup]="updateForm" class="update-form">
        <h3>Update Selected Jobs ({{ selection.selected.length }} selected)</h3>

        <div class="update-controls">
          <mat-form-field appearance="outline" class="status-field">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option value="">No Change</mat-option>
              <mat-option value="Unallocated">Unallocated</mat-option>
              <mat-option value="Allocated">Allocated</mat-option>
              <mat-option value="Collected">Collected</mat-option>
              <mat-option value="Delivered">Delivered</mat-option>
              <mat-option value="Cancelled">Cancelled</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="team-field">
            <mat-label>Team</mat-label>
            <mat-select formControlName="team">
              <mat-option value="">No Change</mat-option>
              <mat-option *ngFor="let team of teams" [value]="team">{{
                team
              }}</mat-option>
            </mat-select>
          </mat-form-field>

          <button
            mat-raised-button
            color="primary"
            class="update-button"
            [disabled]="
              (!updateForm.get('status')?.value &&
                !updateForm.get('team')?.value) ||
              selection.selected.length === 0
            "
            (click)="updateSelectedJobs()"
          >
            <mat-icon>update</mat-icon>
            Update Jobs
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Jobs table -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div class="table-container" *ngIf="!loading">
    <table mat-table [dataSource]="dataSource" matSort class="jobs-table">
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            *ngIf="isMultiSelectActive"
            (change)="$event ? toggleAllRows() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            [aria-label]="checkboxLabel()"
          >
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            *ngIf="isMultiSelectActive"
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"
            [aria-label]="checkboxLabel(row)"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Job ID</th>
        <td mat-cell *matCellDef="let job">{{ job.id }}</td>
      </ng-container>

      <!-- Vehicle Column -->
      <ng-container matColumnDef="vehicle">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Vehicle</th>
        <td mat-cell *matCellDef="let job">
          {{ job.vehicleMake }} {{ job.vehicleModel }}
        </td>
      </ng-container>

      <!-- Registration Column -->
      <ng-container matColumnDef="registration">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Registration</th>
        <td mat-cell *matCellDef="let job">{{ job.vehicleRegistration }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let job">
          <span
            class="status-badge"
            [style.background-color]="getStatusColor(job.status)"
          >
            {{ job.status }}
          </span>
        </td>
      </ng-container>

      <!-- Current Driver Column -->
      <ng-container matColumnDef="currentDriver">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Current Driver
        </th>
        <td mat-cell *matCellDef="let job">
          {{ job.currentDriver || "Unassigned" }}
        </td>
      </ng-container>

      <!-- Team Column -->
      <ng-container matColumnDef="team">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Team</th>
        <td mat-cell *matCellDef="let job">{{ job.team }}</td>
      </ng-container>

      <!-- Collection Date Column -->
      <ng-container matColumnDef="collectionDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Collection Date
        </th>
        <td mat-cell *matCellDef="let job">
          {{ formatDate(job.collectionDate) }}
        </td>
      </ng-container>

      <!-- Delivery Date Column -->
      <ng-container matColumnDef="deliveryDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Delivery Date</th>
        <td mat-cell *matCellDef="let job">
          {{ formatDate(job.deliveryDate) }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let job">
          <button
            mat-icon-button
            color="primary"
            (click)="viewJob(job.id); $event.stopPropagation()"
          >
            <mat-icon>edit</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Row definitions -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let job; columns: displayedColumns"
        (click)="viewJob(job.id)"
        class="job-row"
      ></tr>

      <!-- No data row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="10">
          No jobs found matching the current filters
        </td>
      </tr>
    </table>

    <!-- Paginator -->
    <mat-paginator
      [pageSizeOptions]="[10, 25, 50]"
      [pageSize]="50"
      showFirstLastButtons
      aria-label="Select page of jobs"
    >
    </mat-paginator>
  </div>
</div>
