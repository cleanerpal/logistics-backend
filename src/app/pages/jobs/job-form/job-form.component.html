<div class="job-form-container">
  <div class="page-header">
    <h1 class="page-title">{{ isEditMode ? "Edit Job" : "Create New Job" }}</h1>

    <div class="header-actions" *ngIf="isEditMode && isSuperAdmin">
      <button
        mat-raised-button
        color="primary"
        class="handover-button"
        (click)="openHandoverDialog()"
      >
        <mat-icon>swap_horiz</mat-icon>
        Initiate Handover
      </button>
    </div>
  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Job form -->
  <form [formGroup]="jobForm" (ngSubmit)="onSubmit()" *ngIf="!loading">
    <!-- Job Type Section -->
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>Job Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="job-type-section">
          <div class="form-row">
            <label class="section-label">Job Type</label>
            <mat-radio-group formControlName="jobType" class="job-type-group">
              <mat-radio-button value="Standard">Standard</mat-radio-button>
              <mat-radio-button value="Split Journey"
                >Split Journey</mat-radio-button
              >
            </mat-radio-group>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Customer Reference</mat-label>
              <input matInput formControlName="customerReference" />
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Shipping Reference</mat-label>
              <input matInput formControlName="shippingReference" />
              <mat-error
                *ngIf="jobForm.get('shippingReference')?.hasError('required')"
              >
                Shipping Reference is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row priority-row">
            <label class="priority-label">Priority Job</label>
            <mat-slide-toggle
              formControlName="priority"
              color="primary"
            ></mat-slide-toggle>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Vehicle Details Section -->
    <mat-card class="form-card" formGroupName="vehicleDetails">
      <mat-card-header>
        <mat-card-title>Vehicle Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Vehicle Type</mat-label>
            <mat-select formControlName="type">
              <mat-option *ngFor="let type of vehicleTypes" [value]="type">
                {{ type }}
              </mat-option>
            </mat-select>
            <mat-error
              *ngIf="jobForm.get('vehicleDetails.type')?.hasError('required')"
            >
              Vehicle type is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Make</mat-label>
            <input matInput formControlName="make" />
            <mat-error
              *ngIf="jobForm.get('vehicleDetails.make')?.hasError('required')"
            >
              Make is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Model</mat-label>
            <input matInput formControlName="model" />
            <mat-error
              *ngIf="jobForm.get('vehicleDetails.model')?.hasError('required')"
            >
              Model is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Registration</mat-label>
            <input matInput formControlName="registration" />
            <mat-error
              *ngIf="
                jobForm.get('vehicleDetails.registration')?.hasError('required')
              "
            >
              Registration is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Year</mat-label>
            <input matInput formControlName="year" type="number" />
            <mat-error
              *ngIf="jobForm.get('vehicleDetails.year')?.hasError('required')"
            >
              Year is required
            </mat-error>
            <mat-error
              *ngIf="
                jobForm.get('vehicleDetails.year')?.hasError('min') ||
                jobForm.get('vehicleDetails.year')?.hasError('max')
              "
            >
              Please enter a valid year
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Location</mat-label>
            <input
              matInput
              formControlName="location"
              [matAutocomplete]="locationAuto"
            />
            <mat-autocomplete #locationAuto="matAutocomplete">
              <mat-option
                *ngFor="let address of addressOptions"
                [value]="address.companyName"
              >
                {{ address.companyName }} ({{ address.city }})
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Collection Details Section -->
    <mat-card class="form-card" formGroupName="collectionDetails">
      <mat-card-header>
        <mat-card-title>Collection Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="address-options">
          <span class="address-label">Fill from saved address:</span>
          <button
            type="button"
            mat-stroked-button
            class="address-button"
            [matMenuTriggerFor]="addressMenu"
          >
            <mat-icon>location_on</mat-icon>
            Select Address
          </button>
          <mat-menu #addressMenu="matMenu">
            <button
              mat-menu-item
              *ngFor="let address of addressOptions"
              (click)="fillAddressFields('collectionDetails', address)"
            >
              {{ address.companyName }} - {{ address.city }},
              {{ address.postcode }}
            </button>
          </mat-menu>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Building Number/Name</mat-label>
            <input matInput formControlName="building" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.building')?.hasError('required')
              "
            >
              Building number/name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Street</mat-label>
            <input matInput formControlName="street" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.street')?.hasError('required')
              "
            >
              Street is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>City</mat-label>
            <input matInput formControlName="city" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.city')?.hasError('required')
              "
            >
              City is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Postcode</mat-label>
            <input matInput formControlName="postcode" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.postcode')?.hasError('required')
              "
            >
              Postcode is required
            </mat-error>
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.postcode')?.hasError('pattern')
              "
            >
              Please enter a valid UK postcode
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Country</mat-label>
            <input matInput formControlName="country" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.country')?.hasError('required')
              "
            >
              Country is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Collection Date</mat-label>
            <input
              matInput
              [matDatepicker]="collectionPicker"
              formControlName="date"
            />
            <mat-datepicker-toggle
              matIconSuffix
              [for]="collectionPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #collectionPicker></mat-datepicker>
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.date')?.hasError('required')
              "
            >
              Collection date is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Contact Name</mat-label>
            <input matInput formControlName="contactName" />
            <mat-error
              *ngIf="
                jobForm
                  .get('collectionDetails.contactName')
                  ?.hasError('required')
              "
            >
              Contact name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Contact Phone</mat-label>
            <input matInput formControlName="contactPhone" />
            <mat-error
              *ngIf="
                jobForm
                  .get('collectionDetails.contactPhone')
                  ?.hasError('required')
              "
            >
              Contact phone is required
            </mat-error>
            <mat-error
              *ngIf="
                jobForm
                  .get('collectionDetails.contactPhone')
                  ?.hasError('pattern')
              "
            >
              Please enter a valid UK phone number
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Contact Email</mat-label>
            <input matInput formControlName="contactEmail" type="email" />
            <mat-error
              *ngIf="
                jobForm.get('collectionDetails.contactEmail')?.hasError('email')
              "
            >
              Please enter a valid email
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Special Instructions</mat-label>
            <textarea
              matInput
              formControlName="instructions"
              rows="3"
            ></textarea>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Delivery Details Section -->
    <mat-card class="form-card" formGroupName="deliveryDetails">
      <mat-card-header>
        <mat-card-title>Delivery Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="address-options">
          <span class="address-label">Fill from saved address:</span>
          <button
            type="button"
            mat-stroked-button
            class="address-button"
            [matMenuTriggerFor]="deliveryAddressMenu"
          >
            <mat-icon>location_on</mat-icon>
            Select Address
          </button>
          <mat-menu #deliveryAddressMenu="matMenu">
            <button
              mat-menu-item
              *ngFor="let address of addressOptions"
              (click)="fillAddressFields('deliveryDetails', address)"
            >
              {{ address.companyName }} - {{ address.city }},
              {{ address.postcode }}
            </button>
          </mat-menu>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Building Number/Name</mat-label>
            <input matInput formControlName="building" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.building')?.hasError('required')
              "
            >
              Building number/name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Street</mat-label>
            <input matInput formControlName="street" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.street')?.hasError('required')
              "
            >
              Street is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>City</mat-label>
            <input matInput formControlName="city" />
            <mat-error
              *ngIf="jobForm.get('deliveryDetails.city')?.hasError('required')"
            >
              City is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Postcode</mat-label>
            <input matInput formControlName="postcode" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.postcode')?.hasError('required')
              "
            >
              Postcode is required
            </mat-error>
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.postcode')?.hasError('pattern')
              "
            >
              Please enter a valid UK postcode
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Country</mat-label>
            <input matInput formControlName="country" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.country')?.hasError('required')
              "
            >
              Country is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Delivery Date</mat-label>
            <input
              matInput
              [matDatepicker]="deliveryPicker"
              formControlName="date"
            />
            <mat-datepicker-toggle
              matIconSuffix
              [for]="deliveryPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #deliveryPicker></mat-datepicker>
            <mat-error
              *ngIf="jobForm.get('deliveryDetails.date')?.hasError('required')"
            >
              Delivery date is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row row-split">
          <mat-form-field appearance="outline">
            <mat-label>Contact Name</mat-label>
            <input matInput formControlName="contactName" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.contactName')?.hasError('required')
              "
            >
              Contact name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Contact Phone</mat-label>
            <input matInput formControlName="contactPhone" />
            <mat-error
              *ngIf="
                jobForm
                  .get('deliveryDetails.contactPhone')
                  ?.hasError('required')
              "
            >
              Contact phone is required
            </mat-error>
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.contactPhone')?.hasError('pattern')
              "
            >
              Please enter a valid UK phone number
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Contact Email</mat-label>
            <input matInput formControlName="contactEmail" type="email" />
            <mat-error
              *ngIf="
                jobForm.get('deliveryDetails.contactEmail')?.hasError('email')
              "
            >
              Please enter a valid email
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Special Instructions</mat-label>
            <textarea
              matInput
              formControlName="instructions"
              rows="3"
            ></textarea>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Secondary Points Section (for Split Journey) -->
    <ng-container *ngIf="jobForm.get('jobType')?.value === 'Split Journey'">
      <mat-card
        class="form-card"
        *ngFor="let point of secondaryPoints.controls; let i = index"
        [formGroup]="$any(point)"
      >
        <mat-card-header>
          <mat-card-title>Secondary Point {{ i + 1 }}</mat-card-title>
          <button
            type="button"
            mat-icon-button
            color="warn"
            (click)="removeSecondaryPoint(i)"
            *ngIf="secondaryPoints.length > 1"
            class="remove-button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row row-split">
            <mat-form-field appearance="outline">
              <mat-label>Building Number/Name</mat-label>
              <input matInput formControlName="building" />
              <mat-error *ngIf="point.get('building')?.hasError('required')">
                Building number/name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Street</mat-label>
              <input matInput formControlName="street" />
              <mat-error *ngIf="point.get('street')?.hasError('required')">
                Street is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row row-split">
            <mat-form-field appearance="outline">
              <mat-label>City</mat-label>
              <input matInput formControlName="city" />
              <mat-error *ngIf="point.get('city')?.hasError('required')">
                City is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Postcode</mat-label>
              <input matInput formControlName="postcode" />
              <mat-error *ngIf="point.get('postcode')?.hasError('required')">
                Postcode is required
              </mat-error>
              <mat-error *ngIf="point.get('postcode')?.hasError('pattern')">
                Please enter a valid UK postcode
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row row-split">
            <mat-form-field appearance="outline">
              <mat-label>Country</mat-label>
              <input matInput formControlName="country" />
              <mat-error *ngIf="point.get('country')?.hasError('required')">
                Country is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Contact Name</mat-label>
              <input matInput formControlName="contactName" />
              <mat-error *ngIf="point.get('contactName')?.hasError('required')">
                Contact name is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row row-split">
            <mat-form-field appearance="outline">
              <mat-label>Contact Phone</mat-label>
              <input matInput formControlName="contactPhone" />
              <mat-error
                *ngIf="point.get('contactPhone')?.hasError('required')"
              >
                Contact phone is required
              </mat-error>
              <mat-error *ngIf="point.get('contactPhone')?.hasError('pattern')">
                Please enter a valid UK phone number
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Contact Email</mat-label>
              <input matInput formControlName="contactEmail" type="email" />
              <mat-error *ngIf="point.get('contactEmail')?.hasError('email')">
                Please enter a valid email
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Special Instructions</mat-label>
              <textarea
                matInput
                formControlName="instructions"
                rows="2"
              ></textarea>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="add-secondary-button-container">
        <button
          type="button"
          mat-stroked-button
          color="primary"
          (click)="addSecondaryPoint()"
        >
          <mat-icon>add</mat-icon>
          Add Secondary Point
        </button>
      </div>
    </ng-container>

    <!-- Team Assignment Section -->
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>Team Assignment</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Team</mat-label>
            <mat-select formControlName="team">
              <mat-option value="">Unassigned</mat-option>
              <mat-option *ngFor="let team of teams" [value]="team">{{
                team
              }}</mat-option>
            </mat-select>
            <mat-error *ngIf="jobForm.get('team')?.hasError('required')">
              Team assignment is required
            </mat-error>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Driver Timeline Section (Edit mode only) -->
    <ng-container *ngIf="isEditMode && driverTimeline.length > 0">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Driver Timeline</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table
            mat-table
            [dataSource]="driverTimeline"
            class="driver-timeline-table"
          >
            <!-- Driver Name Column -->
            <ng-container matColumnDef="driverName">
              <th mat-header-cell *matHeaderCellDef>Driver</th>
              <td
                mat-cell
                *matCellDef="let item"
                [class.current-driver]="item.isCurrent"
              >
                {{ item.driverName }}
                <span class="current-label" *ngIf="item.isCurrent"
                  >(Current)</span
                >
              </td>
            </ng-container>

            <!-- Start Time Column -->
            <ng-container matColumnDef="startTime">
              <th mat-header-cell *matHeaderCellDef>Start Time</th>
              <td
                mat-cell
                *matCellDef="let item"
                [class.current-driver]="item.isCurrent"
              >
                {{ formatDate(item.startTime) }}
              </td>
            </ng-container>

            <!-- End Time Column -->
            <ng-container matColumnDef="endTime">
              <th mat-header-cell *matHeaderCellDef>End Time</th>
              <td
                mat-cell
                *matCellDef="let item"
                [class.current-driver]="item.isCurrent"
              >
                {{ item.endTime ? formatDate(item.endTime) : "Active" }}
              </td>
            </ng-container>

            <!-- Notes Column -->
            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td
                mat-cell
                *matCellDef="let item"
                [class.current-driver]="item.isCurrent"
              >
                {{ item.notes }}
              </td>
            </ng-container>

            <!-- Current Column -->
            <ng-container matColumnDef="current">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td
                mat-cell
                *matCellDef="let item"
                [class.current-driver]="item.isCurrent"
              >
                <mat-icon *ngIf="item.isCurrent" class="current-icon"
                  >check_circle</mat-icon
                >
              </td>
            </ng-container>

            <!-- Row Definition -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </ng-container>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" mat-stroked-button (click)="onCancel()">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>

      <button
        type="submit"
        mat-raised-button
        color="primary"
        [disabled]="saving"
      >
        <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
        <span *ngIf="!saving">
          <mat-icon>save</mat-icon>
          {{ isEditMode ? "Update" : "Create" }} Job
        </span>
      </button>
    </div>
  </form>
</div>
