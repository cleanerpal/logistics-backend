<div class="job-details-page">
  <!-- Loading Spinner -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading job details...</span>
  </div>

  <!-- Sticky Header -->
  <header class="sticky-header" *ngIf="job">
    <div class="header-content">
      <div class="header-left">
        <button class="back-btn" (click)="goBack()">
          <span class="material-icons">arrow_back</span>
          Back to Jobs
        </button>
        <div class="job-identifier">
          <h1>{{ job.id }}</h1>
          <span class="status-badge" [ngClass]="getStatusClass(job.status)">
            {{ job.status | titlecase }}
          </span>
        </div>
      </div>

      <div class="header-actions">
        <button
          class="action-btn"
          (click)="editJob()"
          *ngIf="hasEditPermission || isAdmin"
        >
          <span class="material-icons">edit</span>
          Edit
        </button>
        <button class="action-btn" (click)="printJobDetails()">
          <span class="material-icons">print</span>
          Print
        </button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-navigation">
      <button
        [class.active]="activeTab === 'details'"
        (click)="setActiveTab('details')"
      >
        Details
      </button>
      <button
        [class.active]="activeTab === 'timeline'"
        (click)="setActiveTab('timeline')"
      >
        Timeline
      </button>
      <button
        [class.active]="activeTab === 'expenses'"
        (click)="setActiveTab('expenses')"
      >
        Expenses
      </button>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="main-content" *ngIf="job">
    <!-- Details Tab -->
    <div class="tab-content" *ngIf="activeTab === 'details'">
      <div class="two-column-layout">
        <!-- Left Column -->
        <div class="left-column">
          <!-- Customer Card -->
          <div class="info-card">
            <h2>Customer Information</h2>
            <div class="card-content">
              <div class="info-row">
                <span class="label">Name</span>
                <span class="value">{{ job.customerName || "N/A" }}</span>
              </div>
              <div class="info-row">
                <span class="label">Contact</span>
                <span class="value">{{ job.customerContact || "N/A" }}</span>
              </div>
              <div class="info-row">
                <span class="label">Phone</span>
                <span class="value">{{
                  job.customerContactPhone || "N/A"
                }}</span>
              </div>
            </div>
          </div>

          <!-- Vehicle Card -->
          <div class="info-card">
            <h2>Vehicle Details</h2>
            <div class="card-content">
              <div class="info-row">
                <span class="label">Make & Model</span>
                <span class="value"
                  >{{ job.make || "N/A" }} {{ job.model || "" }}</span
                >
              </div>
              <div class="info-row">
                <span class="label">Type</span>
                <span class="value">{{ job["vehicleType"] || "N/A" }}</span>
              </div>
              <div class="info-row">
                <span class="label">Registration</span>
                <span class="value">{{ job.registration || "N/A" }}</span>
              </div>
              <div class="info-row" *ngIf="job.color">
                <span class="label">Color</span>
                <span class="value">{{ job.color }}</span>
              </div>
              <div class="info-row" *ngIf="job.year">
                <span class="label">Year</span>
                <span class="value">{{ job.year }}</span>
              </div>
              <div class="info-row" *ngIf="job.mileage">
                <span class="label">Mileage</span>
                <span class="value">{{ job.mileage }}</span>
              </div>
              <div class="info-row" *ngIf="job.fuelType">
                <span class="label">Fuel Type</span>
                <span class="value">{{ job.fuelType }}</span>
              </div>
              <div class="info-row" *ngIf="job.fuelLevel">
                <span class="label">Fuel Level</span>
                <span class="value">{{ job.fuelLevel }}</span>
              </div>
            </div>
          </div>

          <!-- Addresses Card -->
          <div class="info-card">
            <h2>Addresses</h2>
            <div class="card-content">
              <div class="address-section">
                <h3>Collection</h3>
                <p>{{ job.collectionAddress || "Not specified" }}</p>
                <p *ngIf="job.collectionCity">
                  <strong>City:</strong> {{ job.collectionCity }}
                </p>
                <p *ngIf="job.collectionPostcode">
                  <strong>Postcode:</strong> {{ job.collectionPostcode }}
                </p>
                <p *ngIf="job.collectionContactName">
                  <strong>Contact:</strong> {{ job.collectionContactName }}
                </p>
                <p *ngIf="job.collectionContactPhone">
                  <strong>Phone:</strong> {{ job.collectionContactPhone }}
                </p>
                <p *ngIf="job.collectionNotes" class="instructions">
                  <strong>Notes:</strong> {{ job.collectionNotes }}
                </p>
              </div>
              <div class="address-section">
                <h3>Delivery</h3>
                <p>{{ job.deliveryAddress || "Not specified" }}</p>
                <p *ngIf="job.deliveryCity">
                  <strong>City:</strong> {{ job.deliveryCity }}
                </p>
                <p *ngIf="job.deliveryPostcode">
                  <strong>Postcode:</strong> {{ job.deliveryPostcode }}
                </p>
                <p *ngIf="job.deliveryContactName">
                  <strong>Contact:</strong> {{ job.deliveryContactName }}
                </p>
                <p *ngIf="job.deliveryContactPhone">
                  <strong>Phone:</strong> {{ job.deliveryContactPhone }}
                </p>
                <p *ngIf="job.deliveryNotes" class="instructions">
                  <strong>Notes:</strong> {{ job.deliveryNotes }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
          <!-- Status Card -->
          <div
            class="info-card status-card"
            [ngClass]="getStatusClass(job.status)"
          >
            <h2>Current Status</h2>
            <div class="current-status">
              <span class="status-indicator"></span>
              <div class="status-details">
                <span class="status-text">{{ job.status | titlecase }}</span>
                <span class="current-driver" *ngIf="job.driverId">
                  Driver ID: {{ job.driverId }}
                </span>
                <span class="stage" *ngIf="job.stage">
                  Stage: {{ job.stage }}
                </span>
              </div>
            </div>

            <!-- Status Change -->
            <div
              class="status-change"
              *ngIf="
                hasEditPermission || isAdmin || job.driverId === currentUser?.id
              "
            >
              <h3>Change Status</h3>
              <div class="status-buttons">
                <button
                  *ngFor="let status of allowedStatuses"
                  [class.active]="job.status === status"
                  (click)="updateJobStatus(status)"
                  class="status-button"
                >
                  {{ status | titlecase }}
                </button>
              </div>
            </div>
          </div>

          <!-- Driver Card -->
          <div class="info-card" *ngIf="job.driverId">
            <h2>Assigned Driver</h2>
            <div class="card-content">
              <div class="info-row">
                <span class="label">Driver ID</span>
                <span class="value">{{ job.driverId }}</span>
              </div>
              <div class="info-row" *ngIf="job.allocatedAt">
                <span class="label">Assigned Date</span>
                <span class="value">{{ formatDate(job.allocatedAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Timestamps Card -->
          <div class="info-card">
            <h2>Timeline</h2>
            <div class="card-content">
              <div class="info-row">
                <span class="label">Created</span>
                <span class="value">{{ formatDate(job.createdAt) }}</span>
              </div>
              <div class="info-row" *ngIf="job.allocatedAt">
                <span class="label">Allocated</span>
                <span class="value">{{ formatDate(job.allocatedAt) }}</span>
              </div>
              <div class="info-row" *ngIf="job.collectionStartTime">
                <span class="label">Collection Started</span>
                <span class="value">{{
                  formatDate(job.collectionStartTime)
                }}</span>
              </div>
              <div class="info-row" *ngIf="job.collectionCompleteTime">
                <span class="label">Collection Completed</span>
                <span class="value">{{
                  formatDate(job.collectionCompleteTime)
                }}</span>
              </div>
              <div class="info-row" *ngIf="job.deliveryStartTime">
                <span class="label">Delivery Started</span>
                <span class="value">{{
                  formatDate(job.deliveryStartTime)
                }}</span>
              </div>
              <div class="info-row" *ngIf="job.deliveryCompleteTime">
                <span class="label">Delivery Completed</span>
                <span class="value">{{
                  formatDate(job.deliveryCompleteTime)
                }}</span>
              </div>
              <div class="info-row">
                <span class="label">Last Updated</span>
                <span class="value">{{ formatDate(job.updatedAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Notes Card -->
          <div class="info-card">
            <h2>Notes</h2>
            <div class="card-content">
              <div class="notes-container">
                <div class="notes-list">
                  <div *ngIf="jobNotes.length === 0" class="empty-notes">
                    <p>No notes available for this job</p>
                  </div>
                  <div *ngFor="let note of jobNotes" class="note">
                    <div class="note-header">
                      <span class="note-author">{{ note.author }}</span>
                      <span class="note-date">{{ formatDate(note.date) }}</span>
                    </div>
                    <div class="note-content">{{ note.content }}</div>
                  </div>
                </div>

                <!-- Add Note Form -->
                <div
                  class="add-note-form"
                  *ngIf="
                    hasEditPermission ||
                    isAdmin ||
                    job.driverId === currentUser?.id
                  "
                >
                  <textarea
                    [(ngModel)]="newNote"
                    placeholder="Add a note..."
                    rows="2"
                  ></textarea>
                  <button
                    class="add-note-button"
                    [disabled]="!newNote.trim()"
                    (click)="addNote()"
                  >
                    <span class="material-icons">add</span>
                    Add Note
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline Tab -->
    <div class="tab-content" *ngIf="activeTab === 'timeline'">
      <div class="timeline-view">
        <div class="timeline-header">
          <h2>Job Timeline</h2>
        </div>

        <!-- Display history in timeline format -->
        <div class="timeline-container">
          <!-- Created event -->
          <div class="timeline-event">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">add_circle</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Job Created</h3>
                <time class="event-time">{{ formatDate(job.createdAt) }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.createdBy || "System" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Allocated event -->
          <div class="timeline-event" *ngIf="job.allocatedAt">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">assignment_ind</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Job Allocated</h3>
                <time class="event-time">{{
                  formatDate(job.allocatedAt)
                }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.driverId || "Unknown" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Collection start event -->
          <div class="timeline-event" *ngIf="job.collectionStartTime">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">departure_board</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Collection Started</h3>
                <time class="event-time">{{
                  formatDate(job.collectionStartTime)
                }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.driverId || "Unknown" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Collection complete event -->
          <div class="timeline-event" *ngIf="job.collectionCompleteTime">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">check_circle</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Collection Completed</h3>
                <time class="event-time">{{
                  formatDate(job.collectionCompleteTime)
                }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.driverId || "Unknown" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Delivery start event -->
          <div class="timeline-event" *ngIf="job.deliveryStartTime">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">local_shipping</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Delivery Started</h3>
                <time class="event-time">{{
                  formatDate(job.deliveryStartTime)
                }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.driverId || "Unknown" }}
                </span>
              </div>
            </div>
          </div>

          <!-- Delivery complete event -->
          <div class="timeline-event" *ngIf="job.deliveryCompleteTime">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="material-icons">done_all</span>
              </div>
              <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
              <div class="event-header">
                <h3 class="event-status">Delivery Completed</h3>
                <time class="event-time">{{
                  formatDate(job.deliveryCompleteTime)
                }}</time>
              </div>
              <div class="event-metadata">
                <span class="metadata-item">
                  <span class="material-icons">person</span>
                  {{ job.driverId || "Unknown" }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Expenses Tab -->
    <div class="tab-content" *ngIf="activeTab === 'expenses'">
      <div class="expenses-view">
        <div class="expenses-header">
          <h2>Job Expenses</h2>
          <button
            class="add-expense-button"
            *ngIf="job.driverId === currentUser?.id || isAdmin"
          >
            <span class="material-icons">add</span>
            Add Expense
          </button>
        </div>

        <!-- This section would integrate with your expense service -->
        <!-- For now, showing a placeholder -->
        <div class="empty-expenses">
          <span class="material-icons">receipt_long</span>
          <p>No expenses yet for this job</p>
        </div>
      </div>
    </div>
  </main>

  <!-- No Job Found Message -->
  <div class="not-found" *ngIf="!isLoading && !job">
    <mat-icon>error_outline</mat-icon>
    <h2>Job Not Found</h2>
    <p>The job you're looking for could not be found.</p>
    <button mat-raised-button color="primary" (click)="goBack()">
      Back to Jobs
    </button>
  </div>
</div>
