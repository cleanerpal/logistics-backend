<h2 mat-dialog-title>Initiate Vehicle Handover</h2>

<div mat-dialog-content class="handover-dialog-content">
  <mat-stepper #stepper linear>
    <!-- Step 1: Handover Details -->
    <mat-step [stepControl]="detailsForm">
      <ng-template matStepLabel>Handover Details</ng-template>

      <div class="loading-container" *ngIf="loadingJobs">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading active jobs...</span>
      </div>

      <form [formGroup]="detailsForm" *ngIf="!loadingJobs">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Job</mat-label>
            <mat-select formControlName="jobId" required>
              <mat-option *ngFor="let job of activeJobs" [value]="job.id">
                {{ job.jobId }} - {{ job.vehicleId }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="detailsForm.get('jobId')?.hasError('required')">
              Job is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline">
            <mat-label>Vehicle</mat-label>
            <input matInput formControlName="vehicleId" readonly />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Current Driver</mat-label>
            <input matInput formControlName="fromDriver" readonly />
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline">
            <mat-label>Odometer</mat-label>
            <input
              matInput
              type="number"
              formControlName="odometer"
              placeholder="Current reading"
              required
            />
            <mat-error
              *ngIf="detailsForm.get('odometer')?.hasError('required')"
            >
              Odometer reading is required
            </mat-error>
            <mat-error *ngIf="detailsForm.get('odometer')?.hasError('min')">
              Odometer reading must be positive
            </mat-error>
            <mat-error *ngIf="detailsForm.get('odometer')?.hasError('pattern')">
              Odometer reading must be a number
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Location</mat-label>
            <input
              matInput
              formControlName="location"
              placeholder="Handover location"
              required
            />
            <mat-error
              *ngIf="detailsForm.get('location')?.hasError('required')"
            >
              Location is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reason for Handover</mat-label>
            <mat-select formControlName="reason" required>
              <mat-option
                *ngFor="let reason of reasonOptions"
                [value]="reason.value"
              >
                {{ reason.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="detailsForm.get('reason')?.hasError('required')">
              Reason is required
            </mat-error>
          </mat-form-field>
        </div>

        <div
          class="form-row"
          *ngIf="detailsForm.get('reason')?.value === 'other'"
        >
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Custom Reason</mat-label>
            <textarea
              matInput
              formControlName="customReason"
              rows="3"
              placeholder="Specify reason for handover"
            ></textarea>
            <mat-error
              *ngIf="detailsForm.get('customReason')?.hasError('required')"
            >
              Custom reason is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="step-actions">
          <button mat-button mat-dialog-close color="warn">Cancel</button>
          <button
            mat-raised-button
            color="primary"
            matStepperNext
            [disabled]="detailsForm.invalid"
          >
            Next
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: Driver Selection -->
    <mat-step [stepControl]="driversForm">
      <ng-template matStepLabel>Driver Selection</ng-template>

      <div class="loading-container" *ngIf="loadingDrivers">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading available drivers...</span>
      </div>

      <form [formGroup]="driversForm" *ngIf="!loadingDrivers">
        <h3>Select New Driver</h3>
        <p class="step-description">
          Select the driver who will take over vehicle
          <span class="highlight">{{
            detailsForm.get("vehicleId")?.value
          }}</span>
          from
          <span class="highlight">{{
            detailsForm.get("fromDriver")?.value
          }}</span>
        </p>

        <div class="driver-list-container">
          <mat-error
            *ngIf="
              driversForm.get('toDriverId')?.invalid &&
              driversForm.get('toDriverId')?.touched
            "
          >
            Please select a driver
          </mat-error>

          <mat-selection-list #driversList [multiple]="false">
            <mat-list-option
              *ngFor="let driver of availableDrivers"
              [value]="driver.id"
              [disabled]="driver.id === selectedJob?.currentDriverId"
              [selected]="driversForm.get('toDriverId')?.value === driver.id"
              (click)="driversForm.patchValue({ toDriverId: driver.id })"
            >
              <div class="driver-list-item">
                <div class="driver-avatar">
                  <img
                    *ngIf="driver.photoURL"
                    [src]="driver.photoURL"
                    alt="{{ driver.displayName }}"
                  />
                  <mat-icon *ngIf="!driver.photoURL">person</mat-icon>
                </div>
                <div class="driver-info">
                  <h4>{{ driver.displayName }}</h4>
                  <p>{{ driver.email }}</p>
                </div>
                <div class="driver-role">
                  <span
                    class="role-badge"
                    [ngClass]="driver.role.toLowerCase()"
                    >{{ driver.role }}</span
                  >
                </div>
              </div>
            </mat-list-option>
          </mat-selection-list>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>Back</button>
          <button
            mat-raised-button
            color="primary"
            matStepperNext
            [disabled]="driversForm.invalid"
          >
            Next
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 3: Confirmation and Signatures -->
    <mat-step [stepControl]="confirmationForm">
      <ng-template matStepLabel>Confirmation</ng-template>

      <form [formGroup]="confirmationForm" (ngSubmit)="submitHandover()">
        <h3>Confirm Handover</h3>

        <div class="handover-summary">
          <div class="summary-item">
            <span class="summary-label">Job ID:</span>
            <span class="summary-value">{{ selectedJob?.jobId }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Vehicle:</span>
            <span class="summary-value">{{
              detailsForm.get("vehicleId")?.value
            }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">From Driver:</span>
            <span class="summary-value">{{
              detailsForm.get("fromDriver")?.value
            }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">To Driver:</span>
            <span class="summary-value">{{
              getDriverName(driversForm.get("toDriverId")?.value)
            }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Location:</span>
            <span class="summary-value">{{
              detailsForm.get("location")?.value
            }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Odometer:</span>
            <span class="summary-value">{{
              detailsForm.get("odometer")?.value
            }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Reason:</span>
            <span class="summary-value">{{ getReasonLabel() }}</span>
          </div>
        </div>

        <div class="signature-section">
          <h4>Driver Signatures</h4>

          <!-- From Driver Signature -->
          <div class="signature-container">
            <div class="signature-header">
              <span
                >From Driver: {{ detailsForm.get("fromDriver")?.value }}</span
              >
              <mat-checkbox formControlName="skipFromSignature"
                >Skip signature</mat-checkbox
              >
            </div>

            <div
              *ngIf="!confirmationForm.get('skipFromSignature')?.value"
              class="canvas-container"
            >
              <canvas
                #fromSignatureCanvas
                width="400"
                height="150"
                (mousedown)="startDrawing($event, 'from')"
                (mousemove)="draw($event, 'from')"
                (mouseup)="stopDrawing('from')"
                (mouseleave)="stopDrawing('from')"
                (touchstart)="startDrawing($event, 'from')"
                (touchmove)="draw($event, 'from')"
                (touchend)="stopDrawing('from')"
              >
              </canvas>
              <button
                type="button"
                mat-button
                color="warn"
                (click)="clearSignature('from')"
              >
                <mat-icon>delete</mat-icon> Clear
              </button>
            </div>

            <div
              *ngIf="confirmationForm.get('skipFromSignature')?.value"
              class="signature-note-container"
            >
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Reason for skipping signature</mat-label>
                <textarea
                  matInput
                  formControlName="fromSignatureNotes"
                  rows="2"
                  placeholder="Explain why signature is being skipped"
                ></textarea>
                <mat-error
                  *ngIf="
                    confirmationForm
                      .get('fromSignatureNotes')
                      ?.hasError('required')
                  "
                >
                  Reason for skipping signature is required
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- To Driver Signature -->
          <div class="signature-container">
            <div class="signature-header">
              <span
                >To Driver:
                {{ getDriverName(driversForm.get("toDriverId")?.value) }}</span
              >
              <mat-checkbox formControlName="skipToSignature"
                >Skip signature</mat-checkbox
              >
            </div>

            <div
              *ngIf="!confirmationForm.get('skipToSignature')?.value"
              class="canvas-container"
            >
              <canvas
                #toSignatureCanvas
                width="400"
                height="150"
                (mousedown)="startDrawing($event, 'to')"
                (mousemove)="draw($event, 'to')"
                (mouseup)="stopDrawing('to')"
                (mouseleave)="stopDrawing('to')"
                (touchstart)="startDrawing($event, 'to')"
                (touchmove)="draw($event, 'to')"
                (touchend)="stopDrawing('to')"
              >
              </canvas>
              <button
                type="button"
                mat-button
                color="warn"
                (click)="clearSignature('to')"
              >
                <mat-icon>delete</mat-icon> Clear
              </button>
            </div>

            <div
              *ngIf="confirmationForm.get('skipToSignature')?.value"
              class="signature-note-container"
            >
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Reason for skipping signature</mat-label>
                <textarea
                  matInput
                  formControlName="toSignatureNotes"
                  rows="2"
                  placeholder="Explain why signature is being skipped"
                ></textarea>
                <mat-error
                  *ngIf="
                    confirmationForm
                      .get('toSignatureNotes')
                      ?.hasError('required')
                  "
                >
                  Reason for skipping signature is required
                </mat-error>
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Additional Notes</mat-label>
            <textarea
              matInput
              formControlName="notes"
              rows="3"
              placeholder="Any additional information about this handover"
            ></textarea>
          </mat-form-field>
        </div>

        <div class="step-actions">
          <button type="button" mat-button matStepperPrevious>Back</button>
          <button
            type="submit"
            mat-raised-button
            color="primary"
            [disabled]="submitting || confirmationForm.invalid"
          >
            <mat-spinner diameter="20" *ngIf="submitting"></mat-spinner>
            <span *ngIf="!submitting">Complete Handover</span>
          </button>
        </div>
      </form>
    </mat-step>
  </mat-stepper>
</div>
