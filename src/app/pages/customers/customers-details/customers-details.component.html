<!-- company-details.component.html -->
<mat-card class="mat-elevation-z3">
  <!-- Loading Spinner -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading company details...</span>
  </div>

  <!-- Header -->
  <div class="header-wrapper">
    <div class="header-title">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-content">
        <h1>{{ company?.name }}</h1>
        <div class="company-status" *ngIf="company">
          <span class="status-chip" [ngClass]="getStatusClass(company.status)">
            {{ company.status }}
          </span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="deleteCompany()" *ngIf="hasEditPermission">
        <mat-icon>delete</mat-icon>
        Delete Company
      </button>
      <button mat-flat-button color="primary" (click)="editCompany()" *ngIf="hasEditPermission">
        <mat-icon>edit</mat-icon>
        Edit Company
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button [class.active]="activeTab === 'details'" (click)="setActiveTab('details')">Details</button>
    <button [class.active]="activeTab === 'jobs'" (click)="setActiveTab('jobs')">Jobs</button>
    <button [class.active]="activeTab === 'notes'" (click)="setActiveTab('notes')">Notes</button>
  </div>

  <!-- Company Details -->
  <mat-card-content class="content-wrapper" *ngIf="company">
    <div [ngSwitch]="activeTab">
      <!-- Details Tab -->
      <div *ngSwitchCase="'details'" class="details-tab">
        <div class="details-grid">
          <!-- Company Information -->
          <mat-card class="details-section">
            <h2>Company Information</h2>
            <div class="info-grid">
              <div class="info-item">
                <label>Industry</label>
                <div class="value-with-icon">
                  <mat-icon>{{ getIndustryIcon(company.industry) }}</mat-icon>
                  <span>{{ company.industry }}</span>
                </div>
              </div>
              <div class="info-item">
                <label>Size</label>
                <span>{{ company.size }}</span>
              </div>
              <div class="info-item">
                <label>Status</label>
                <span class="status-chip small" [ngClass]="getStatusClass(company.status)">
                  {{ company.status }}
                </span>
              </div>
              <div class="info-item">
                <label>Website</label>
                <a *ngIf="company.website" [href]="company.website" target="_blank" rel="noopener noreferrer">
                  {{ company.website }}
                </a>
                <span *ngIf="!company.website">Not provided</span>
              </div>
              <div class="info-item full-width">
                <label>Description</label>
                <p>{{ company.description || 'No description provided' }}</p>
              </div>
              <div class="info-item">
                <label>Created</label>
                <span>{{ company.createdAt | date }}</span>
              </div>
              <div class="info-item">
                <label>Last Updated</label>
                <span>{{ company.updatedAt | date }}</span>
              </div>
              <div class="info-item">
                <label>Last Contact</label>
                <span>{{ company.lastContact | date }}</span>
              </div>
            </div>
          </mat-card>

          <!-- Address Section -->
          <mat-card class="details-section">
            <h2>Address</h2>
            <div class="info-grid">
              <div class="info-item full-width">
                <label>Street Address</label>
                <p class="address">{{ company.address }}</p>
              </div>
              <div class="info-item">
                <label>City</label>
                <span>{{ company.city || 'Not provided' }}</span>
              </div>
              <div class="info-item">
                <label>Postcode</label>
                <span>{{ company.postcode || 'Not provided' }}</span>
              </div>
              <div class="info-item">
                <label>Country</label>
                <span>{{ company.country || 'Not provided' }}</span>
              </div>
            </div>
          </mat-card>
        </div>

        <!-- Contacts Section -->
        <mat-card class="contacts-section">
          <h2>Contacts</h2>
          <div class="contacts-grid">
            <div *ngFor="let contact of company.contacts" class="contact-card">
              <div class="contact-header">
                <div class="contact-name">{{ contact.name }}</div>
                <div class="contact-badge" *ngIf="contact.isPrimary">Primary</div>
              </div>
              <div class="contact-position" *ngIf="contact.position">{{ contact.position }}</div>
              <div class="contact-details">
                <div class="contact-item">
                  <mat-icon>email</mat-icon>
                  <a [href]="'mailto:' + contact.email">{{ contact.email }}</a>
                </div>
                <div class="contact-item" *ngIf="contact.phone">
                  <mat-icon>phone</mat-icon>
                  <a [href]="'tel:' + contact.phone">{{ contact.phone }}</a>
                </div>
              </div>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Jobs Tab -->
      <div *ngSwitchCase="'jobs'" class="jobs-tab">
        <mat-card class="jobs-section">
          <div class="section-header">
            <h2>Job History</h2>
            <button mat-stroked-button color="primary" [routerLink]="['/jobs/new']" [queryParams]="{ companyId: company.id }">
              <mat-icon>add</mat-icon>
              New Job
            </button>
          </div>

          <!-- Loading Jobs Spinner -->
          <div class="loading-overlay" *ngIf="isJobsLoading">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading jobs...</span>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="jobsDataSource" class="jobs-table">
              <!-- ID Column -->
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>Job ID</th>
                <td mat-cell *matCellDef="let job">{{ job.id }}</td>
              </ng-container>

              <!-- Title Column -->
              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef>Title</th>
                <td mat-cell *matCellDef="let job">{{ job.title }}</td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let job">{{ job.type }}</td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let job">
                  <span class="status-chip small" [ngClass]="getStatusClass(job.status)">
                    {{ job.status }}
                  </span>
                </td>
              </ng-container>

              <!-- Start Date Column -->
              <ng-container matColumnDef="startDate">
                <th mat-header-cell *matHeaderCellDef>Start Date</th>
                <td mat-cell *matCellDef="let job">{{ job.startDate | date }}</td>
              </ng-container>

              <!-- End Date Column -->
              <ng-container matColumnDef="endDate">
                <th mat-header-cell *matHeaderCellDef>End Date</th>
                <td mat-cell *matCellDef="let job">
                  {{ job.endDate ? (job.endDate | date) : 'Ongoing' }}
                </td>
              </ng-container>

              <!-- Value Column -->
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Value</th>
                <td mat-cell *matCellDef="let job">
                  {{ formatCurrency(job.value) }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let job">
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu" xPosition="before">
                    <button mat-menu-item (click)="viewJobDetails(job.id)">
                      <mat-icon>visibility</mat-icon>
                      <span>View Details</span>
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="viewJobDetails(row.id)" class="job-row"></tr>
            </table>

            <!-- Empty state for jobs -->
            <div class="empty-state" *ngIf="!isJobsLoading && jobsDataSource.data.length === 0">
              <mat-icon>work_off</mat-icon>
              <h3>No Jobs Found</h3>
              <p>This company doesn't have any jobs yet.</p>
              <button mat-flat-button color="primary" [routerLink]="['/jobs/new']" [queryParams]="{ companyId: company.id }">
                <mat-icon>add</mat-icon>
                Create First Job
              </button>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Notes Tab -->
      <div *ngSwitchCase="'notes'" class="notes-tab">
        <mat-card class="notes-section">
          <h2>Company Notes</h2>
          <div class="notes-content">
            <div class="note" *ngIf="company.notes">
              <p>{{ company.notes }}</p>
            </div>
            <div class="empty-notes" *ngIf="!company.notes">
              <mat-icon>note</mat-icon>
              <p>No notes available for this company</p>
              <button mat-stroked-button color="primary" (click)="editCompany()" *ngIf="hasEditPermission">
                <mat-icon>edit</mat-icon>
                Add Notes
              </button>
            </div>
          </div>
        </mat-card>
      </div>
    </div>
  </mat-card-content>
</mat-card>
