<div class="settings-container">
  <div class="page-header">
    <h1 class="page-title">System Settings</h1>
    <p class="page-subtitle">
      Manage your system configurations and preferences
    </p>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p class="loading-text">Loading settings...</p>
  </div>

  <div *ngIf="!isLoading && isSuperAdmin" class="settings-content">
    <mat-card class="settings-card">
      <mat-card-content>
        <mat-tab-group animationDuration="300ms">
          <!-- INTEGRATIONS TAB -->
          <mat-tab label="Integrations">
            <div class="tab-content">
              <form [formGroup]="integrationsForm">
                <!-- Google Calendar Integration -->
                <div class="section-container">
                  <div class="section-header">
                    <h2>Google Calendar</h2>
                    <p>
                      Connect to Google Calendar to sync appointments and driver
                      schedules
                    </p>
                  </div>

                  <div
                    class="connection-status"
                    *ngIf="
                      integrationsForm.get('googleCalendar.connected')?.value
                    "
                  >
                    <mat-icon class="status-icon connected"
                      >check_circle</mat-icon
                    >
                    <span class="status-text">Connected</span>
                  </div>

                  <div
                    formGroupName="googleCalendar"
                    class="form-row-container"
                  >
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Client ID</mat-label>
                        <input
                          matInput
                          formControlName="clientId"
                          placeholder="Enter Google Calendar Client ID"
                          type="text"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Client ID from Google API Console"
                          >info</mat-icon
                        >
                        <mat-error
                          *ngIf="
                            integrationsForm
                              .get('googleCalendar.clientId')
                              ?.hasError('required')
                          "
                        >
                          Client ID is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Client Secret</mat-label>
                        <input
                          matInput
                          formControlName="clientSecret"
                          placeholder="Enter Google Calendar Client Secret"
                          type="password"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Client Secret from Google API Console"
                          >info</mat-icon
                        >
                        <mat-error
                          *ngIf="
                            integrationsForm
                              .get('googleCalendar.clientSecret')
                              ?.hasError('required')
                          "
                        >
                          Client Secret is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Refresh Token</mat-label>
                        <input
                          matInput
                          formControlName="refreshToken"
                          placeholder="Enter Google Calendar Refresh Token"
                          type="password"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Refresh Token from OAuth flow"
                          >info</mat-icon
                        >
                      </mat-form-field>
                    </div>
                  </div>

                  <div class="form-actions">
                    <button
                      mat-raised-button
                      color="primary"
                      class="test-connection-btn"
                      [disabled]="
                        isSaving ||
                        !integrationsForm.get('googleCalendar')?.valid
                      "
                      (click)="testGoogleCalendarConnection()"
                    >
                      <mat-icon>sync</mat-icon> Test Connection
                    </button>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- QuickBooks Integration -->
                <div class="section-container">
                  <div class="section-header">
                    <h2>QuickBooks</h2>
                    <p>
                      Connect to QuickBooks for financial data and invoice
                      management
                    </p>
                  </div>

                  <div
                    class="connection-status"
                    *ngIf="integrationsForm.get('quickBooks.connected')?.value"
                  >
                    <mat-icon class="status-icon connected"
                      >check_circle</mat-icon
                    >
                    <span class="status-text">Connected</span>
                  </div>

                  <div formGroupName="quickBooks" class="form-row-container">
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Client ID</mat-label>
                        <input
                          matInput
                          formControlName="clientId"
                          placeholder="Enter QuickBooks Client ID"
                          type="text"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Client ID from QuickBooks Developer Portal"
                          >info</mat-icon
                        >
                        <mat-error
                          *ngIf="
                            integrationsForm
                              .get('quickBooks.clientId')
                              ?.hasError('required')
                          "
                        >
                          Client ID is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Client Secret</mat-label>
                        <input
                          matInput
                          formControlName="clientSecret"
                          placeholder="Enter QuickBooks Client Secret"
                          type="password"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Client Secret from QuickBooks Developer Portal"
                          >info</mat-icon
                        >
                        <mat-error
                          *ngIf="
                            integrationsForm
                              .get('quickBooks.clientSecret')
                              ?.hasError('required')
                          "
                        >
                          Client Secret is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Refresh Token</mat-label>
                        <input
                          matInput
                          formControlName="refreshToken"
                          placeholder="Enter QuickBooks Refresh Token"
                          type="password"
                        />
                        <mat-icon
                          matSuffix
                          matTooltip="Refresh Token from OAuth flow"
                          >info</mat-icon
                        >
                      </mat-form-field>
                    </div>
                  </div>

                  <div class="form-actions">
                    <button
                      mat-raised-button
                      color="primary"
                      class="test-connection-btn"
                      [disabled]="
                        isSaving || !integrationsForm.get('quickBooks')?.valid
                      "
                      (click)="testQuickBooksConnection()"
                    >
                      <mat-icon>sync</mat-icon> Test Connection
                    </button>
                  </div>
                </div>

                <div class="tab-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    class="save-btn"
                    [disabled]="isSaving || integrationsForm.invalid"
                    (click)="saveIntegrations()"
                  >
                    <mat-icon>save</mat-icon>
                    <span>Save Integrations</span>
                  </button>
                </div>
              </form>
            </div>
          </mat-tab>

          <!-- BILLING TAB -->
          <mat-tab label="Billing">
            <div class="tab-content">
              <form [formGroup]="billingForm">
                <div class="section-container">
                  <div class="section-header">
                    <h2>Invoice Settings</h2>
                    <p>Configure your invoice and payment preferences</p>
                  </div>

                  <div class="form-row-container">
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Payment Terms</mat-label>
                        <mat-select formControlName="paymentTerms">
                          <mat-option value="Net 7"
                            >Net 7 (Due in 7 days)</mat-option
                          >
                          <mat-option value="Net 15"
                            >Net 15 (Due in 15 days)</mat-option
                          >
                          <mat-option value="Net 30"
                            >Net 30 (Due in 30 days)</mat-option
                          >
                          <mat-option value="Net 45"
                            >Net 45 (Due in 45 days)</mat-option
                          >
                          <mat-option value="Net 60"
                            >Net 60 (Due in 60 days)</mat-option
                          >
                          <mat-option value="Due on Receipt"
                            >Due on Receipt</mat-option
                          >
                        </mat-select>
                        <mat-error
                          *ngIf="
                            billingForm
                              .get('paymentTerms')
                              ?.hasError('required')
                          "
                        >
                          Payment terms are required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Invoice Footer Text</mat-label>
                        <textarea
                          matInput
                          formControlName="invoiceFooter"
                          placeholder="Enter text to appear at the bottom of all invoices"
                          rows="6"
                        ></textarea>
                        <mat-hint
                          >This text will appear at the bottom of all
                          invoices</mat-hint
                        >
                      </mat-form-field>
                    </div>
                  </div>
                </div>

                <div class="tab-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    class="save-btn"
                    [disabled]="isSaving || billingForm.invalid"
                    (click)="saveBillingSettings()"
                  >
                    <mat-icon>save</mat-icon>
                    <span>Save Billing Settings</span>
                  </button>
                </div>
              </form>
            </div>
          </mat-tab>

          <!-- COMPANY DETAILS TAB -->
          <mat-tab label="Company Details">
            <div class="tab-content">
              <form [formGroup]="companyDetailsForm">
                <div class="section-container">
                  <div class="section-header">
                    <h2>Company Information</h2>
                    <p>Update your company's basic information</p>
                  </div>

                  <div class="company-logo-container">
                    <div class="logo-preview" *ngIf="logoUrl">
                      <img [src]="logoUrl" alt="Company Logo" />
                      <button
                        mat-mini-fab
                        color="warn"
                        class="remove-logo-btn"
                        (click)="resetLogoUpload()"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>

                    <div class="logo-upload">
                      <input
                        type="file"
                        id="logo-upload"
                        #logoUpload
                        hidden
                        (change)="onFileSelected($event)"
                        accept="image/*"
                      />
                      <button
                        mat-raised-button
                        type="button"
                        (click)="logoUploadInput.nativeElement.click()"
                      >
                        <mat-icon>upload</mat-icon> Upload Logo
                      </button>
                      <p class="upload-hint">
                        Recommended size: 400x200px, max 2MB, PNG or JPEG
                      </p>
                    </div>

                    <mat-progress-bar
                      *ngIf="uploadProgress > 0"
                      mode="determinate"
                      [value]="uploadProgress"
                    ></mat-progress-bar>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Company Name</mat-label>
                      <input
                        matInput
                        formControlName="companyName"
                        placeholder="Enter company name"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('companyName')
                            ?.hasError('required')
                        "
                      >
                        Company name is required
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Tax ID / VAT Number</mat-label>
                      <input
                        matInput
                        formControlName="taxId"
                        placeholder="Enter Tax ID or VAT Number"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm.get('taxId')?.hasError('required')
                        "
                      >
                        Tax ID is required
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <div class="section-container" formGroupName="address">
                  <div class="section-header">
                    <h2>Company Address</h2>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Street Address</mat-label>
                      <input
                        matInput
                        formControlName="street"
                        placeholder="Enter street address"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('address.street')
                            ?.hasError('required')
                        "
                      >
                        Street address is required
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row multi-field">
                    <mat-form-field appearance="outline">
                      <mat-label>City</mat-label>
                      <input
                        matInput
                        formControlName="city"
                        placeholder="Enter city"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('address.city')
                            ?.hasError('required')
                        "
                      >
                        City is required
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>State/Province</mat-label>
                      <input
                        matInput
                        formControlName="state"
                        placeholder="Enter state"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('address.state')
                            ?.hasError('required')
                        "
                      >
                        State is required
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row multi-field">
                    <mat-form-field appearance="outline">
                      <mat-label>Country</mat-label>
                      <input
                        matInput
                        formControlName="country"
                        placeholder="Enter country"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('address.country')
                            ?.hasError('required')
                        "
                      >
                        Country is required
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Postal/ZIP Code</mat-label>
                      <input
                        matInput
                        formControlName="zip"
                        placeholder="Enter postal code"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('address.zip')
                            ?.hasError('required')
                        "
                      >
                        Postal code is required
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <div class="section-container" formGroupName="bankDetails">
                  <div class="section-header">
                    <h2>Banking Details</h2>
                    <p>Used for payment information on invoices</p>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Account Number</mat-label>
                      <input
                        matInput
                        formControlName="accountNumber"
                        placeholder="Enter account number"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('bankDetails.accountNumber')
                            ?.hasError('required')
                        "
                      >
                        Account number is required
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Sort Code</mat-label>
                      <input
                        matInput
                        formControlName="sortCode"
                        placeholder="Enter sort code"
                        type="text"
                      />
                      <mat-error
                        *ngIf="
                          companyDetailsForm
                            .get('bankDetails.sortCode')
                            ?.hasError('required')
                        "
                      >
                        Sort code is required
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <div class="tab-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    class="save-btn"
                    [disabled]="isSaving || companyDetailsForm.invalid"
                    (click)="saveCompanyDetails()"
                  >
                    <mat-icon>save</mat-icon>
                    <span>Save Company Details</span>
                  </button>
                </div>
              </form>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Access Denied Message for non-SuperAdmin users -->
  <div *ngIf="!isLoading && !isSuperAdmin" class="access-denied">
    <mat-icon class="access-denied-icon">security</mat-icon>
    <h2>Access Denied</h2>
    <p>Only Super Admins can access system settings.</p>
  </div>
</div>
